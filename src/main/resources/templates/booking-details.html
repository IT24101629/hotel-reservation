<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Booking Details - Hotel Reservation System</title>
</head>
<body>
    <div th:fragment="content">
        <div class="container">
            <!-- Page Header -->
            <section class="mt-2 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>üìã Booking Details</h1>
                        <p>Booking Reference: <strong th:text="${booking.bookingReference}">BK123456789</strong></p>
                    </div>
                    <div>
                        <a href="/my-bookings" class="btn btn-secondary">‚Üê Back to My Bookings</a>
                    </div>
                </div>
            </section>
            
            <!-- Booking Status Alert -->
            <div th:if="${booking.bookingStatus.name() == 'CANCELLED'}" class="alert alert-danger">
                <h4>‚ùå This booking has been cancelled</h4>
                <p th:if="${booking.cancellationReason}">Reason: <span th:text="${booking.cancellationReason}"></span></p>
                <p th:if="${booking.cancelledAt}">Cancelled on: <span th:text="${#temporals.format(booking.cancelledAt, 'MMM dd, yyyy HH:mm')}"></span></p>
            </div>
            
            <div th:if="${booking.bookingStatus.name() == 'PENDING_PAYMENT'}" class="alert alert-warning">
                <h4>‚è≥ Payment Pending</h4>
                <p>Your booking is confirmed but payment is still pending. Please complete your payment to secure your reservation.</p>
                <a th:href="@{'/payment?bookingId=' + ${booking.bookingId}}" class="btn btn-primary">Complete Payment</a>
            </div>
            
            <div th:if="${booking.bookingStatus.name() == 'CONFIRMED'}" class="alert alert-success">
                <h4>‚úÖ Booking Confirmed</h4>
                <p>Your booking is confirmed and payment has been processed successfully.</p>
            </div>

            <!-- Booking Information -->
            <div class="row">
                <!-- Main Details -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3>üè® Booking Information</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>üìÖ Stay Details</h5>
                                    <p><strong>Check-in:</strong> <span th:text="${#temporals.format(booking.checkInDate, 'EEEE, MMM dd, yyyy')}">Monday, Dec 25, 2023</span></p>
                                    <p><strong>Check-out:</strong> <span th:text="${#temporals.format(booking.checkOutDate, 'EEEE, MMM dd, yyyy')}">Wednesday, Dec 27, 2023</span></p>
                                    <p><strong>Duration:</strong> <span th:text="${booking.numberOfNights}">2</span> night<span th:text="${booking.numberOfNights > 1 ? 's' : ''}">s</span></p>
                                    <p><strong>Guests:</strong> <span th:text="${booking.numberOfGuests}">2</span> guest<span th:text="${booking.numberOfGuests > 1 ? 's' : ''}">s</span></p>
                                </div>
                                <div class="col-md-6">
                                    <h5>üè® Room Details</h5>
                                    <p><strong>Room Number:</strong> <span th:text="${booking.roomNumber}">201</span></p>
                                    <p><strong>Room Type:</strong> <span th:text="${booking.roomTypeName}">Deluxe Room</span></p>
                                    <p><strong>Rate per Night:</strong> LKR <span th:text="${#numbers.formatDecimal(booking.roomPricePerNight, 1, 2)}">18,000.00</span></p>
                                </div>
                            </div>
                            
                            <!-- Special Requests -->
                            <div th:if="${booking.specialRequests}" class="mt-3">
                                <h5>üìù Special Requests</h5>
                                <p th:text="${booking.specialRequests}">Late check-in requested</p>
                            </div>
                            
                            <!-- Customer Notes -->
                            <div th:if="${booking.customerNotes}" class="mt-3">
                                <h5>üí¨ Your Notes</h5>
                                <p th:text="${booking.customerNotes}">Anniversary celebration</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="card mt-3" th:if="${booking.bookingStatus.name() != 'CANCELLED'}">
                        <div class="card-header">
                            <h3>‚ö° Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6" th:if="${booking.bookingStatus.name() == 'PENDING_PAYMENT'}">
                                    <a th:href="@{'/payment?bookingId=' + ${booking.bookingId}}" class="btn btn-success btn-lg w-100">
                                        üí≥ Complete Payment
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <button id="cancelBookingBtn" class="btn btn-danger btn-lg w-100" 
                                            th:data-booking-id="${booking.bookingId}"
                                            th:data-booking-ref="${booking.bookingReference}">
                                        ‚ùå Cancel Booking
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Summary -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h3>üí∞ Payment Summary</h3>
                        </div>
                        <div class="card-body">
                            <div class="summary-item">
                                <span>Room Rate:</span>
                                <span>LKR <span th:text="${#numbers.formatDecimal(booking.roomPricePerNight, 1, 2)}">18,000.00</span></span>
                            </div>
                            <div class="summary-item">
                                <span>Number of Nights:</span>
                                <span th:text="${booking.numberOfNights}">2</span>
                            </div>
                            <div class="summary-item">
                                <span>Subtotal:</span>
                                <span>LKR <span th:text="${#numbers.formatDecimal(booking.roomPricePerNight * booking.numberOfNights, 1, 2)}">36,000.00</span></span>
                            </div>
                            <div class="summary-item">
                                <span>Service Charge (10%):</span>
                                <span>LKR <span th:text="${#numbers.formatDecimal((booking.roomPricePerNight * booking.numberOfNights) * 0.10, 1, 2)}">3,600.00</span></span>
                            </div>
                            <div class="summary-item">
                                <span>Taxes (2%):</span>
                                <span>LKR <span th:text="${#numbers.formatDecimal((booking.roomPricePerNight * booking.numberOfNights) * 0.02, 1, 2)}">720.00</span></span>
                            </div>
                            <div class="total-amount">
                                <div class="summary-item">
                                    <span><strong>Total Amount:</strong></span>
                                    <span><strong>LKR <span th:text="${#numbers.formatDecimal(booking.totalAmount, 1, 2)}">40,320.00</span></strong></span>
                                </div>
                            </div>
                            
                            <!-- Payment Status -->
                            <div class="mt-3">
                                <h5>üí≥ Payment Status</h5>
                                <span class="badge" 
                                      th:classappend="${booking.paymentStatus.name() == 'COMPLETED'} ? 'bg-success' : 
                                                     ${booking.paymentStatus.name() == 'PENDING'} ? 'bg-warning' : 
                                                     ${booking.paymentStatus.name() == 'FAILED'} ? 'bg-danger' : 'bg-secondary'"
                                      th:text="${booking.paymentStatus.name()}">PENDING</span>
                            </div>
                            
                            <!-- Booking Status -->
                            <div class="mt-2">
                                <h5>üìã Booking Status</h5>
                                <span class="badge" 
                                      th:classappend="${booking.bookingStatus.name() == 'CONFIRMED'} ? 'bg-success' : 
                                                     ${booking.bookingStatus.name() == 'PENDING_PAYMENT'} ? 'bg-warning' : 
                                                     ${booking.bookingStatus.name() == 'CANCELLED'} ? 'bg-danger' : 
                                                     ${booking.bookingStatus.name() == 'CHECKED_IN'} ? 'bg-info' : 'bg-secondary'"
                                      th:text="${booking.bookingStatus.name()}">PENDING_PAYMENT</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Information -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3>üë§ Customer Information</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Name:</strong> <span th:text="${booking.customerName}">John Doe</span></p>
                            <p><strong>Email:</strong> <span th:text="${booking.customerEmail}">john@example.com</span></p>
                            <p th:if="${booking.customerPhone}"><strong>Phone:</strong> <span th:text="${booking.customerPhone}">+94771234567</span></p>
                            <p><strong>Booked on:</strong> <span th:text="${#temporals.format(booking.createdAt, 'MMM dd, yyyy HH:mm')}">Dec 20, 2023 14:30</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript for cancel booking -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cancelBtn = document.getElementById('cancelBookingBtn');
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    const bookingRef = this.getAttribute('data-booking-ref');
                    
                    // Show confirmation dialog
                    if (confirm(`Are you sure you want to cancel booking ${bookingRef}?\n\nThis action cannot be undone. If you have already made a payment, refunds will be processed according to our cancellation policy.`)) {
                        // Show loading state
                        this.disabled = true;
                        this.innerHTML = '‚è≥ Cancelling...';
                        
                        // Make API call to cancel booking
                        fetch(`/api/bookings/${bookingId}/cancel`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || ''
                            },
                            body: 'reason=Cancelled by customer via booking details page'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('‚úÖ Booking cancelled successfully!');
                                // Reload the page to show updated status
                                window.location.reload();
                            } else {
                                alert('‚ùå Error cancelling booking: ' + (data.error || 'Unknown error'));
                                // Restore button
                                this.disabled = false;
                                this.innerHTML = '‚ùå Cancel Booking';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('‚ùå Error cancelling booking. Please try again.');
                            // Restore button
                            this.disabled = false;
                            this.innerHTML = '‚ùå Cancel Booking';
                        });
                    }
                });
            }
        });
    </script>
    
    <style>
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }
        
        .total-amount {
            border-top: 2px solid #dee2e6;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        
        .total-amount .summary-item {
            font-size: 1.1rem;
        }
        
        .badge {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        
        .alert h4 {
            margin-bottom: 0.5rem;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .align-items-center {
            align-items: center;
        }
    </style>
</body>
</html>