<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Edit Booking - Hotel Reservation System</title>
</head>
<body>
<div th:fragment="content">
    <div class="container">
        <!-- Page Header -->
        <section class="mt-2 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>âœï¸ Edit Booking</h1>
                    <p>Update your reservation details</p>
                </div>
                <div>
                    <a th:href="@{'/booking/' + ${booking.bookingId}}" class="btn btn-secondary">â† Back to Booking</a>
                </div>
            </div>
        </section>

        <!-- Current Booking Information -->
        <section class="mb-3" th:if="${booking != null}">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“‹ Current Booking Information</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-section">
                                <h4>ğŸ« Booking Reference</h4>
                                <p class="booking-ref" th:text="${booking.bookingReference}">BK123456</p>
                            </div>
                            <div class="info-section">
                                <h4>ğŸ¨ Room Details (Cannot be changed)</h4>
                                <p><strong>Room:</strong> <span th:text="${booking.roomNumber + ' (' + booking.roomType + ')'}">101 (Deluxe)</span></p>
                                <p><strong>Dates:</strong> <span th:text="${#temporals.format(booking.checkInDate, 'MMM dd, yyyy')} + ' - ' + ${#temporals.format(booking.checkOutDate, 'MMM dd, yyyy')}">Jan 15 - Jan 18, 2025</span></p>
                                <p><strong>Nights:</strong> <span th:text="${booking.numberOfNights}">3</span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-section">
                                <h4>ğŸ“Š Status</h4>
                                <span class="amenity-tag"
                                      th:classappend="${booking.bookingStatus.name() == 'CONFIRMED' ? 'confirmed' :
                                                     booking.bookingStatus.name() == 'PENDING' ? 'pending' :
                                                     booking.bookingStatus.name() == 'CANCELLED' ? 'cancelled' : ''}"
                                      th:text="${booking.bookingStatus}">CONFIRMED</span>
                            </div>
                            <div class="info-section">
                                <h4>ğŸ’° Total Amount</h4>
                                <p class="amount" th:text="'LKR ' + ${#numbers.formatDecimal(booking.totalAmount, 1, 2)}">LKR 54,000.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Edit Form -->
        <section class="mb-3">
            <div class="card">
                <div class="card-header">
                    <h2>âœï¸ Update Booking Details</h2>
                    <p class="mb-0">You can update the number of guests, special requests, and personal notes. Room and dates cannot be changed.</p>
                </div>
                <div class="card-body">
                    <form id="updateBookingForm">
                        <!-- CSRF Token -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="numberOfGuests">ğŸ‘¥ Number of Guests *</label>
                                    <select class="form-control" id="numberOfGuests" name="numberOfGuests" required>
                                        <option value="">Select number of guests</option>
                                        <option value="1" th:selected="${booking.numberOfGuests == 1}">1 Guest</option>
                                        <option value="2" th:selected="${booking.numberOfGuests == 2}">2 Guests</option>
                                        <option value="3" th:selected="${booking.numberOfGuests == 3}">3 Guests</option>
                                        <option value="4" th:selected="${booking.numberOfGuests == 4}">4 Guests</option>
                                        <option value="5" th:selected="${booking.numberOfGuests == 5}">5 Guests</option>
                                        <option value="6" th:selected="${booking.numberOfGuests == 6}">6 Guests</option>
                                    </select>
                                    <small class="form-text text-muted">Maximum capacity depends on room type</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="status">ğŸ“Š Current Status</label>
                                    <input type="text" class="form-control" id="status" 
                                           th:value="${booking.bookingStatus}" readonly>
                                    <small class="form-text text-muted">Status cannot be changed here</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="specialRequests">ğŸ“ Special Requests</label>
                            <textarea class="form-control" id="specialRequests" name="specialRequests" 
                                      rows="4" placeholder="Any special requests or requirements..."
                                      th:text="${booking.specialRequests}"></textarea>
                            <small class="form-text text-muted">Early check-in, late check-out, special amenities, etc.</small>
                        </div>

                        <div class="form-group">
                            <label for="customerNotes">ğŸ’­ Personal Notes</label>
                            <textarea class="form-control" id="customerNotes" name="customerNotes" 
                                      rows="3" placeholder="Your personal notes about this booking..."
                                      th:text="${booking.customerNotes}"></textarea>
                            <small class="form-text text-muted">Private notes for your reference</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" onclick="return updateBooking();">
                                âœ… Update Booking
                            </button>
                            <a th:href="@{'/booking/' + ${booking.bookingId}}" class="btn btn-secondary" style="margin-left: 0.5rem;">
                                âŒ Cancel Changes
                            </a>
                        </div>
                    </form>
                    
                    <!-- Alternative Form Submission Method -->
                    <div class="mt-3">
                        <h4>ğŸ”„ Alternative Update Method</h4>
                        <p>If the above buttons don't work, try this traditional form submission:</p>
                        <form th:action="@{'/booking/' + ${booking.bookingId} + '/update'}" method="POST">
                            <!-- CSRF Token -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="alt_numberOfGuests">ğŸ‘¥ Number of Guests *</label>
                                        <select class="form-control" id="alt_numberOfGuests" name="numberOfGuests" required>
                                            <option value="">Select number of guests</option>
                                            <option value="1" th:selected="${booking.numberOfGuests == 1}">1 Guest</option>
                                            <option value="2" th:selected="${booking.numberOfGuests == 2}">2 Guests</option>
                                            <option value="3" th:selected="${booking.numberOfGuests == 3}">3 Guests</option>
                                            <option value="4" th:selected="${booking.numberOfGuests == 4}">4 Guests</option>
                                            <option value="5" th:selected="${booking.numberOfGuests == 5}">5 Guests</option>
                                            <option value="6" th:selected="${booking.numberOfGuests == 6}">6 Guests</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="alt_specialRequests">ğŸ“ Special Requests</label>
                                <textarea class="form-control" id="alt_specialRequests" name="specialRequests" 
                                          rows="3" placeholder="Any special requests or requirements..."
                                          th:text="${booking.specialRequests}"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="alt_customerNotes">ğŸ’­ Personal Notes</label>
                                <textarea class="form-control" id="alt_customerNotes" name="customerNotes" 
                                          rows="2" placeholder="Your personal notes about this booking..."
                                          th:text="${booking.customerNotes}"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-warning">
                                ğŸ“‹ Update Booking (Form Submit)
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Important Notice -->
        <section class="mb-3">
            <div class="card">
                <div class="card-body">
                    <h3>â„¹ï¸ Important Information</h3>
                    <ul>
                        <li><strong>Room Changes:</strong> To change your room or dates, you'll need to cancel this booking and create a new one</li>
                        <li><strong>Guest Limit:</strong> Number of guests cannot exceed the room's maximum capacity</li>
                        <li><strong>Cancellation:</strong> You can cancel this booking from the booking details page</li>
                        <li><strong>Contact:</strong> For assistance, call +94 11 1234567 or email support@goldpalmhotel.com</li>
                    </ul>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Additional JavaScript -->
<th:block th:fragment="additional-js">
    <script>
        // Debug information
        console.log('ğŸ”„ Booking edit page loaded');
        console.log('ğŸ“ Booking ID from Thymeleaf:', /*[[${booking.bookingId}]]*/ 0);
        
        function updateBooking() {
            console.log('ğŸ”„ Update function called');
            
            const bookingId = /*[[${booking.bookingId}]]*/ 0;
            
            // Get form values directly
            const numberOfGuests = document.getElementById('numberOfGuests').value;
            const specialRequests = document.getElementById('specialRequests').value || '';
            const customerNotes = document.getElementById('customerNotes').value || '';
            
            console.log('ğŸ“ Form values:', {
                bookingId: bookingId,
                numberOfGuests: numberOfGuests,
                specialRequests: specialRequests,
                customerNotes: customerNotes
            });
            
            // Validate
            if (!numberOfGuests || numberOfGuests === '') {
                alert('âŒ Please select number of guests');
                return false;
            }
            
            const updateData = {
                numberOfGuests: parseInt(numberOfGuests),
                specialRequests: specialRequests,
                customerNotes: customerNotes
            };
            
            console.log('ğŸ“¤ Sending update data:', updateData);
            
            // Show loading
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'â³ Updating...';
            submitBtn.disabled = true;
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || 
                            document.querySelector('input[name="_csrf"]')?.value || '';
            
            console.log('ğŸ” CSRF token:', csrfToken ? 'Found' : 'Missing');
            
            // Try POST method first (more widely supported)
            fetch(`/api/bookings/${bookingId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify(updateData)
            })
            .catch(postError => {
                console.log('ğŸ“¤ POST failed, trying PUT method...', postError);
                // Fallback to PUT method
                return fetch(`/api/bookings/${bookingId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(updateData)
                });
            })
            .then(response => {
                console.log('ğŸ“¥ Response status:', response.status);
                console.log('ğŸ“¥ Response headers:', response.headers);
                return response.text().then(text => {
                    console.log('ğŸ“¥ Raw response:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error('Invalid JSON response: ' + text);
                    }
                });
            })
            .then(data => {
                console.log('âœ… Parsed response:', data);
                if (data.success) {
                    alert('âœ… Booking updated successfully!');
                    window.location.href = `/booking/${bookingId}`;
                } else {
                    alert('âŒ Error: ' + (data.error || 'Update failed'));
                }
            })
            .catch(error => {
                console.error('âŒ Error:', error);
                alert('âŒ Error updating booking: ' + error.message);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
            
            return false; // Prevent form submission
        }
        
        // Set up form when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“‹ DOM ready, setting up form...');
            
            const form = document.getElementById('updateBookingForm');
            if (form) {
                console.log('âœ… Form found, adding event listener');
                form.addEventListener('submit', function(e) {
                    console.log('ğŸ“ Form submit prevented');
                    e.preventDefault();
                    e.stopPropagation();
                    updateBooking();
                });
            } else {
                console.error('âŒ Form not found!');
            }
        });
    </script>
</th:block>

<!-- Additional CSS -->
<th:block th:fragment="additional-css">
    <style>
        .info-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .info-section h4 {
            color: #007bff;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .booking-ref {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745;
            margin: 0;
        }

        .amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #007bff;
            margin: 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-actions {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .form-actions .btn {
            margin-right: 1rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }

        .amenity-tag.confirmed {
            background-color: #d4edda;
            color: #155724;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .amenity-tag.pending {
            background-color: #fff3cd;
            color: #856404;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .amenity-tag.cancelled {
            background-color: #f8d7da;
            color: #721c24;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .card-header p {
            margin-bottom: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .d-flex.justify-content-between {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .d-flex.justify-content-between > div:last-child {
                margin-top: 1rem;
            }
        }
    </style>
</th:block>
</body>
</html>