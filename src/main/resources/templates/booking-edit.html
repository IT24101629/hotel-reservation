<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Edit Booking - Golden Palm Hotel</title>
</head>
<body>
<div th:fragment="content">
    <!-- Hero Section -->
    <section class="hero-section bg-dark" th:if="${booking != null}">
        <div class="container">
            <div class="text-center">
                <div class="fade-in-up">
                    <h1 class="display-4 mb-6 text-golden">
                        <i class="fas fa-edit me-3"></i>
                        Edit Booking
                    </h1>
                </div>
                <div class="fade-in-up" style="animation-delay: 0.2s;">
                    <p class="lead mb-8">
                        Update your reservation details at Golden Palm Hotel
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Booking Not Found -->
    <section class="py-5" th:if="${booking == null}">
        <div class="container">
            <div class="text-center">
                <div class="card shadow-glow">
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <i class="fas fa-exclamation-triangle text-warning display-1"></i>
                        </div>
                        <h2 class="text-warning mb-3">Booking Not Found</h2>
                        <p class="lead mb-4">The booking you're trying to edit could not be found.</p>
                        <a href="/my-bookings" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to My Bookings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div th:if="${booking != null}">

        <!-- Current Booking Information -->
        <section class="py-5">
            <div class="container">
                <div class="card shadow-glow">
                    <div class="card-header text-center">
                        <h2 class="mb-0">
                            <i class="fas fa-info-circle text-golden me-3"></i>
                            Current Booking Information
                        </h2>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 bg-dark">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <i class="fas fa-hashtag text-golden display-6"></i>
                                        </div>
                                        <h5 class="text-golden">Booking Reference</h5>
                                        <p class="fs-3 fw-bold text-golden mb-0" th:text="${booking != null ? booking.bookingReference : 'N/A'}">BK123456</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 bg-dark">
                                    <div class="card-body">
                                        <h5 class="text-golden mb-3">
                                            <i class="fas fa-bed me-2"></i>Room Details
                                        </h5>
                                        <p class="mb-2"><strong>Room:</strong> <span th:text="${booking != null ? booking.roomNumber + ' (' + booking.roomType + ')' : 'N/A'}">101 (Deluxe)</span></p>
                                        <p class="mb-2"><strong>Dates:</strong> <span th:text="${booking != null ? #temporals.format(booking.checkInDate, 'MMM dd, yyyy') + ' - ' + #temporals.format(booking.checkOutDate, 'MMM dd, yyyy') : 'N/A'}">Jan 15 - Jan 18, 2025</span></p>
                                        <p class="mb-2"><strong>Nights:</strong> <span th:text="${booking != null ? booking.numberOfNights : 'N/A'}">3</span></p>
                                        <small class="text-muted">Room and dates cannot be changed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 bg-dark">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <i class="fas fa-flag text-golden display-6"></i>
                                        </div>
                                        <h5 class="text-golden">Status</h5>
                                        <span class="badge bg-success fs-6 px-3 py-2" th:if="${booking != null and booking.bookingStatus != null and booking.bookingStatus.name() == 'CONFIRMED'}">
                                            <i class="fas fa-check-circle me-1"></i>CONFIRMED
                                        </span>
                                        <span class="badge bg-warning fs-6 px-3 py-2" th:if="${booking != null and booking.bookingStatus != null and booking.bookingStatus.name() == 'PENDING'}">
                                            <i class="fas fa-clock me-1"></i>PENDING
                                        </span>
                                        <span class="badge bg-danger fs-6 px-3 py-2" th:if="${booking != null and booking.bookingStatus != null and booking.bookingStatus.name() == 'CANCELLED'}">
                                            <i class="fas fa-times-circle me-1"></i>CANCELLED
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card h-100 border-0 bg-dark">
                                    <div class="card-body text-center">
                                        <div class="mb-3">
                                            <i class="fas fa-rupee-sign text-golden display-6"></i>
                                        </div>
                                        <h5 class="text-golden">Total Amount</h5>
                                        <p class="fs-3 fw-bold text-golden mb-0" th:text="${booking != null ? 'LKR ' + #numbers.formatDecimal(booking.totalAmount, 1, 2) : 'LKR 0.00'}">LKR 54,000.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Edit Form -->
        <section class="py-5">
            <div class="container">
                <div class="card shadow-glow">
                    <div class="card-header text-center">
                        <h2 class="mb-0">
                            <i class="fas fa-edit text-golden me-3"></i>
                            Update Booking Details
                        </h2>
                        <p class="mt-3 mb-0">You can update the number of guests, special requests, and personal notes. Room and dates cannot be changed.</p>
                    </div>
                    <div class="card-body p-5">
                        <form id="updateBookingForm">
                            <!-- CSRF Token -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select class="form-select" id="numberOfGuests" name="numberOfGuests" required>
                                            <option value="">Select number of guests</option>
                                            <option value="1" th:selected="${booking != null and booking.numberOfGuests == 1}">1 Guest</option>
                                            <option value="2" th:selected="${booking != null and booking.numberOfGuests == 2}">2 Guests</option>
                                            <option value="3" th:selected="${booking != null and booking.numberOfGuests == 3}">3 Guests</option>
                                            <option value="4" th:selected="${booking != null and booking.numberOfGuests == 4}">4 Guests</option>
                                            <option value="5" th:selected="${booking != null and booking.numberOfGuests == 5}">5 Guests</option>
                                            <option value="6" th:selected="${booking != null and booking.numberOfGuests == 6}">6 Guests</option>
                                        </select>
                                        <label for="numberOfGuests">
                                            <i class="fas fa-users me-2"></i>Number of Guests *
                                        </label>
                                        <div class="form-text">Maximum capacity depends on room type</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control" id="status" 
                                               th:value="${booking != null ? booking.bookingStatus : ''}" readonly>
                                        <label for="status">
                                            <i class="fas fa-flag me-2"></i>Current Status
                                        </label>
                                        <div class="form-text">Status cannot be changed here</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mt-2">
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control" id="specialRequests" name="specialRequests" 
                                                  style="height: 120px;" placeholder="Any special requests or requirements..."
                                                  th:text="${booking != null ? booking.specialRequests : ''}"></textarea>
                                        <label for="specialRequests">
                                            <i class="fas fa-clipboard-list me-2"></i>Special Requests
                                        </label>
                                        <div class="form-text">Early check-in, late check-out, special amenities, etc.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-4 mt-2">
                                <div class="col-12">
                                    <div class="form-floating">
                                        <textarea class="form-control" id="customerNotes" name="customerNotes" 
                                                  style="height: 100px;" placeholder="Your personal notes about this booking..."
                                                  th:text="${booking != null ? booking.customerNotes : ''}"></textarea>
                                        <label for="customerNotes">
                                            <i class="fas fa-sticky-note me-2"></i>Personal Notes
                                        </label>
                                        <div class="form-text">Private notes for your reference</div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-5">
                                <button type="submit" class="btn btn-primary btn-lg me-3" onclick="return updateBooking();">
                                    <i class="fas fa-save me-2"></i>Update Booking
                                </button>
                                <a th:href="@{'/booking/' + ${booking != null ? booking.bookingId : ''}}" th:if="${booking != null}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>Cancel Changes
                                </a>
                            </div>
                        </form>
                    
                        
                        <!-- Alternative Form Submission Method -->
                        <div class="mt-5 pt-4 border-top">
                            <div class="text-center mb-4">
                                <h4 class="text-golden">
                                    <i class="fas fa-sync-alt me-2"></i>Alternative Update Method
                                </h4>
                                <p class="text-muted">If the above buttons don't work, try this traditional form submission:</p>
                            </div>
                            <form th:action="@{'/booking/' + ${booking != null ? booking.bookingId : ''} + '/update'}" th:if="${booking != null}" method="POST">
                                <!-- CSRF Token -->
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <select class="form-select" id="alt_numberOfGuests" name="numberOfGuests" required>
                                                <option value="">Select number of guests</option>
                                                <option value="1" th:selected="${booking != null and booking.numberOfGuests == 1}">1 Guest</option>
                                                <option value="2" th:selected="${booking != null and booking.numberOfGuests == 2}">2 Guests</option>
                                                <option value="3" th:selected="${booking != null and booking.numberOfGuests == 3}">3 Guests</option>
                                                <option value="4" th:selected="${booking != null and booking.numberOfGuests == 4}">4 Guests</option>
                                                <option value="5" th:selected="${booking != null and booking.numberOfGuests == 5}">5 Guests</option>
                                                <option value="6" th:selected="${booking != null and booking.numberOfGuests == 6}">6 Guests</option>
                                            </select>
                                            <label for="alt_numberOfGuests">
                                                <i class="fas fa-users me-2"></i>Number of Guests *
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-4 mt-2">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="alt_specialRequests" name="specialRequests" 
                                                      style="height: 100px;" placeholder="Any special requests or requirements..."
                                                      th:text="${booking != null ? booking.specialRequests : ''}"></textarea>
                                            <label for="alt_specialRequests">
                                                <i class="fas fa-clipboard-list me-2"></i>Special Requests
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-4 mt-2">
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="alt_customerNotes" name="customerNotes" 
                                                      style="height: 80px;" placeholder="Your personal notes about this booking..."
                                                      th:text="${booking != null ? booking.customerNotes : ''}"></textarea>
                                            <label for="alt_customerNotes">
                                                <i class="fas fa-sticky-note me-2"></i>Personal Notes
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="submit" class="btn btn-warning btn-lg">
                                        <i class="fas fa-edit me-2"></i>Update Booking (Form Submit)
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Important Notice -->
        <section class="py-5">
            <div class="container">
                <div class="card shadow-glow">
                    <div class="card-header text-center">
                        <h3 class="mb-0">
                            <i class="fas fa-info-circle text-info me-3"></i>
                            Important Information
                        </h3>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="d-flex align-items-start">
                                    <div class="me-3 mt-1">
                                        <i class="fas fa-bed text-golden fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold">Room Changes</h6>
                                        <p class="mb-0 small text-muted">To change your room or dates, you'll need to cancel this booking and create a new one</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-start">
                                    <div class="me-3 mt-1">
                                        <i class="fas fa-users text-golden fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold">Guest Limit</h6>
                                        <p class="mb-0 small text-muted">Number of guests cannot exceed the room's maximum capacity</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-start">
                                    <div class="me-3 mt-1">
                                        <i class="fas fa-times-circle text-golden fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold">Cancellation</h6>
                                        <p class="mb-0 small text-muted">You can cancel this booking from the booking details page</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-start">
                                    <div class="me-3 mt-1">
                                        <i class="fas fa-phone text-golden fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold">Contact Support</h6>
                                        <p class="mb-0 small text-muted">Call <strong>011-4545678</strong> or email <strong>support@goldenpalmhotel.com</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div> <!-- End booking != null wrapper -->
    </div>
</div>

<!-- Additional JavaScript -->
<th:block th:fragment="additional-js">
    <script>
        // Debug information
        console.log('🔄 Booking edit page loaded');
        console.log('📝 Booking ID from Thymeleaf:', /*[[${booking != null ? booking.bookingId : 0}]]*/ 0);
        
        function updateBooking() {
            console.log('🔄 Update function called');
            
            const bookingId = /*[[${booking != null ? booking.bookingId : 0}]]*/ 0;
            
            // Get form values directly
            const numberOfGuests = document.getElementById('numberOfGuests').value;
            const specialRequests = document.getElementById('specialRequests').value || '';
            const customerNotes = document.getElementById('customerNotes').value || '';
            
            console.log('📝 Form values:', {
                bookingId: bookingId,
                numberOfGuests: numberOfGuests,
                specialRequests: specialRequests,
                customerNotes: customerNotes
            });
            
            // Validate
            if (!numberOfGuests || numberOfGuests === '') {
                alert('❌ Please select number of guests');
                return false;
            }
            
            const updateData = {
                numberOfGuests: parseInt(numberOfGuests),
                specialRequests: specialRequests,
                customerNotes: customerNotes
            };
            
            console.log('📤 Sending update data:', updateData);
            
            // Show loading
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '⏳ Updating...';
            submitBtn.disabled = true;
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || 
                            document.querySelector('input[name="_csrf"]')?.value || '';
            
            console.log('🔐 CSRF token:', csrfToken ? 'Found' : 'Missing');
            
            // Try POST method first (more widely supported)
            fetch(`/api/bookings/${bookingId}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken
                },
                body: JSON.stringify(updateData)
            })
            .catch(postError => {
                console.log('📤 POST failed, trying PUT method...', postError);
                // Fallback to PUT method
                return fetch(`/api/bookings/${bookingId}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(updateData)
                });
            })
            .then(response => {
                console.log('📥 Response status:', response.status);
                console.log('📥 Response headers:', response.headers);
                return response.text().then(text => {
                    console.log('📥 Raw response:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        throw new Error('Invalid JSON response: ' + text);
                    }
                });
            })
            .then(data => {
                console.log('✅ Parsed response:', data);
                if (data.success) {
                    alert('✅ Booking updated successfully!');
                    window.location.href = `/booking/${bookingId}`;
                } else {
                    alert('❌ Error: ' + (data.error || 'Update failed'));
                }
            })
            .catch(error => {
                console.error('❌ Error:', error);
                alert('❌ Error updating booking: ' + error.message);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
            
            return false; // Prevent form submission
        }
        
        // Set up form when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 DOM ready, setting up form...');
            
            const form = document.getElementById('updateBookingForm');
            if (form) {
                console.log('✅ Form found, adding event listener');
                form.addEventListener('submit', function(e) {
                    console.log('📝 Form submit prevented');
                    e.preventDefault();
                    e.stopPropagation();
                    updateBooking();
                });
            } else {
                console.error('❌ Form not found!');
            }
        });
    </script>
</th:block>

</body>
</html>