<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>PayHere Test</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <h1>PayHere Integration Test</h1>
    
    <div style="margin: 20px 0;">
        <p><strong>Test Parameters:</strong></p>
        <ul>
            <li>Merchant ID: 1221688</li>
            <li>Order ID: TEST-12345</li>
            <li>Amount: 12.00 USD</li>
            <li>Currency: USD</li>
        </ul>
        <p><em>This will generate a hash dynamically and submit to PayHere sandbox.</em></p>
    </div>
    
    <form id="payhere-test-form" method="post" action="https://sandbox.payhere.lk/pay/checkout">
        <!-- PayHere Required Fields -->
        <input type="hidden" name="merchant_id" value="1221688">
        <input type="hidden" name="return_url" value="http://localhost:8080/payment/success">
        <input type="hidden" name="cancel_url" value="http://localhost:8080/payment/cancel">
        <input type="hidden" name="notify_url" value="http://localhost:8080/api/payment/payhere/notify">
        
        <!-- Order Details -->
        <input type="hidden" name="order_id" value="TEST-12345">
        <input type="hidden" name="items" value="Test Hotel Booking">
        <input type="hidden" name="currency" value="USD">
        <input type="hidden" name="amount" value="12.00">
        
        <!-- Customer Details -->
        <input type="hidden" name="first_name" value="Test">
        <input type="hidden" name="last_name" value="Customer">
        <input type="hidden" name="email" value="test@example.com">
        <input type="hidden" name="phone" value="+94771234567">
        <input type="hidden" name="address" value="Test Address">
        <input type="hidden" name="city" value="Colombo">
        <input type="hidden" name="country" value="Sri Lanka">
        
        <!-- Hash (will be generated dynamically) -->
        <input type="hidden" name="hash" id="hash" value="">
        
        <button type="button" onclick="generateHashAndSubmit()">Generate Hash & Test PayHere Payment</button>
        <div id="status" style="margin-top: 10px; font-weight: bold;"></div>
    </form>
    
    <script>
        function generateHashAndSubmit() {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'Generating hash...';
            statusDiv.style.color = 'blue';
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            console.log('CSRF Token:', csrfToken);
            console.log('CSRF Header:', csrfHeader);
            
            // Call the hash generation API
            const headers = {
                'Content-Type': 'application/json'
            };
            headers[csrfHeader] = csrfToken;
            
            fetch('/api/payment/payhere/generate-hash', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    orderId: 'TEST-12345',
                    amount: '12.00',
                    currency: 'USD'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.hash) {
                    document.getElementById('hash').value = data.hash;
                    statusDiv.textContent = 'Hash generated successfully! Redirecting to PayHere...';
                    statusDiv.style.color = 'green';
                    
                    console.log('Generated hash:', data.hash);
                    console.log('Submitting form to PayHere...');
                    
                    // Submit the form to PayHere
                    setTimeout(() => {
                        document.getElementById('payhere-test-form').submit();
                    }, 1000);
                } else {
                    statusDiv.textContent = 'Error generating hash: ' + (data.error || 'Unknown error');
                    statusDiv.style.color = 'red';
                    console.error('Hash generation failed:', data);
                }
            })
            .catch(error => {
                statusDiv.textContent = 'Network error: ' + error.message;
                statusDiv.style.color = 'red';
                console.error('Network error:', error);
            });
        }
        
        console.log('PayHere test form ready');
    </script>
</body>
</html>