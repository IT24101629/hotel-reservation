<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Payment - Hotel Reservation System</title>
</head>
<body>
    <div th:fragment="content">
        <div class="container">
            <!-- Page Header -->
            <section class="mt-2 mb-3 text-center">
                <h1>üí≥ Secure Payment</h1>
                <p>Complete your payment to confirm your booking</p>
            </section>
            
            <!-- Payment Container -->
            <div class="booking-container">
                <!-- Payment Form -->
                <div class="card">
                    <div class="card-header">
                        <h2>üí≥ Payment Information</h2>
                    </div>
                    <div class="card-body">
                        <!-- Booking Information Display -->
                        <div id="bookingInfo" class="mb-3">
                            <h3>üìã Booking Confirmation</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div id="bookingInfoPlaceholder" class="text-center">
                                        <p>Loading booking information...</p>
                                        <div class="spinner"></div>
                                    </div>
                                    <div id="bookingDetails" style="display: none;">
                                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <p><strong>Booking Reference:</strong> <span id="bookingReference">-</span></p>
                                                <p><strong>Room:</strong> <span id="roomDetails">-</span></p>
                                                <p><strong>Guest Name:</strong> <span id="guestName">-</span></p>
                                            </div>
                                            <div>
                                                <p><strong>Check-in:</strong> <span id="checkInDisplay">-</span></p>
                                                <p><strong>Check-out:</strong> <span id="checkOutDisplay">-</span></p>
                                                <p><strong>Duration:</strong> <span id="durationDisplay">-</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method Selection -->
                        <div class="form-group">
                            <h3>üè¶ Select Payment Method</h3>
                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="CREDIT_CARD" onclick="selectPaymentMethod('CREDIT_CARD')">
                                    <h4>üí≥ Credit/Debit Card</h4>
                                    <p>Secure online payment</p>
                                    <small>Visa, Mastercard, American Express</small>
                                </div>
                                
                                <div class="payment-method" data-method="BANK_TRANSFER" onclick="selectPaymentMethod('BANK_TRANSFER')">
                                    <h4>üè¶ Bank Transfer</h4>
                                    <p>Direct bank transfer</p>
                                    <small>Manual verification required</small>
                                </div>
                                
                                <div class="payment-method" data-method="CASH" onclick="selectPaymentMethod('CASH')">
                                    <h4>üí∞ Pay at Hotel</h4>
                                    <p>Pay upon arrival</p>
                                    <small>Cash or card at reception</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Credit Card Payment Form -->
                        <div id="creditCardPaymentSection" class="form-group">
                            <h3>üí≥ Credit/Debit Card Payment</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <strong>üîí Secure Payment:</strong> Your payment is processed securely. We do not store your card details on our servers.
                                    </div>
                                    
                                    <form id="creditCardPaymentForm" novalidate>
                                        <!-- CSRF Token -->
                                        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
                                        <input type="hidden" id="bookingReferenceField" name="bookingReference">
                                        <input type="hidden" id="paymentAmountField" name="amount">
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="cardholderName">Cardholder Name *</label>
                                                    <input type="text" id="cardholderName" name="cardholderName" 
                                                           class="form-control" required 
                                                           placeholder="John Doe"
                                                           pattern="[A-Za-z\s]{2,50}"
                                                           title="Please enter the name as it appears on your card">
                                                    <div class="invalid-feedback">Please enter cardholder name (2-50 characters)</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="cardNumber">Card Number *</label>
                                                    <input type="text" id="cardNumber" name="cardNumber" 
                                                           class="form-control" required 
                                                           placeholder="1234 5678 9012 3456"
                                                           maxlength="19"
                                                           pattern="[0-9\s]{13,19}"
                                                           title="Please enter a valid card number">
                                                    <div class="invalid-feedback">Please enter a valid card number</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="expiryDate">Expiry Date *</label>
                                                    <input type="text" id="expiryDate" name="expiryDate" 
                                                           class="form-control" required 
                                                           placeholder="MM/YY"
                                                           maxlength="5"
                                                           pattern="(0[1-9]|1[0-2])\/\d{2}"
                                                           title="Please enter expiry date in MM/YY format">
                                                    <div class="invalid-feedback">Please enter expiry date (MM/YY)</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="cvv">CVV *</label>
                                                    <input type="text" id="cvv" name="cvv" 
                                                           class="form-control" required 
                                                           placeholder="123"
                                                           maxlength="4"
                                                           pattern="\d{3,4}"
                                                           title="Please enter the 3 or 4 digit CVV code">
                                                    <div class="invalid-feedback">Please enter CVV (3-4 digits)</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Payment Summary in Form -->
                                        <div class="payment-form-summary">
                                            <h4>Payment Summary</h4>
                                            <div class="summary-item">
                                                <span>Total Amount:</span>
                                                <span id="paymentAmount" class="total-amount">LKR 0.00</span>
                                            </div>
                                            <div class="summary-item">
                                                <span>Payment Method:</span>
                                                <span>Credit/Debit Card</span>
                                            </div>
                                            <div class="summary-item">
                                                <span>Processing Fee:</span>
                                                <span>Included</span>
                                            </div>
                                        </div>
                                        
                                        <div class="form-check mt-3">
                                            <input type="checkbox" id="termsAccepted" class="form-check-input" required>
                                            <label for="termsAccepted" class="form-check-label">
                                                I agree to the <a href="/terms" target="_blank">Terms and Conditions</a> and <a href="/privacy" target="_blank">Privacy Policy</a>
                                            </label>
                                            <div class="invalid-feedback">You must accept the terms and conditions</div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <button type="submit" id="payNowBtn" class="btn btn-success form-control" disabled>
                                                üîí Process Payment Securely
                                            </button>
                                            <div id="paymentProgress" class="mt-2" style="display: none;">
                                                <div class="spinner"></div>
                                                <span>Processing payment...</span>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bank Transfer Instructions -->
                        <div id="bankTransferSection" class="form-group" style="display: none;">
                            <h3>üè¶ Bank Transfer Details</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <strong>‚ö†Ô∏è Important:</strong> Your booking will be on hold until payment is verified. Please transfer the exact amount and send proof of payment.
                                    </div>
                                    
                                    <h4>Bank Details:</h4>
                                    <div class="bank-details">
                                        <p><strong>Bank:</strong> Commercial Bank of Ceylon PLC</p>
                                        <p><strong>Account Name:</strong> Gold Palm Hotel (Pvt) Ltd</p>
                                        <p><strong>Account Number:</strong> 8001234567890</p>
                                        <p><strong>Branch:</strong> Colombo Main Branch</p>
                                        <p><strong>SWIFT Code:</strong> CCEYLKLX</p>
                                    </div>
                                    
                                    <h4 class="mt-3">Transfer Instructions:</h4>
                                    <ol>
                                        <li>Transfer the exact amount: <strong id="bankTransferAmount">LKR 0.00</strong></li>
                                        <li>Use booking reference <strong id="bankTransferReference">-</strong> as the transfer reference</li>
                                        <li>Email proof of payment to: <strong>payments@goldpalmhotel.com</strong></li>
                                        <li>Include your booking reference in the email subject</li>
                                    </ol>
                                    
                                    <div class="mt-3">
                                        <button type="button" id="confirmBankTransferBtn" class="btn btn-primary form-control" onclick="confirmBankTransfer()">
                                            üìß I will transfer the amount and send proof
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cash Payment Section -->
                        <div id="cashPaymentSection" class="form-group" style="display: none;">
                            <h3>üí∞ Pay at Hotel</h3>
                            <div class="card">
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <strong>üí° Payment at Hotel:</strong> You can pay when you arrive at the hotel. Your booking will be held for 24 hours.
                                    </div>
                                    
                                    <h4>Payment Information:</h4>
                                    <ul>
                                        <li>Amount to pay: <strong id="cashPaymentAmount">LKR 0.00</strong></li>
                                        <li>Payment methods accepted: Cash, Credit Card, Debit Card</li>
                                        <li>Pay at the reception desk during check-in</li>
                                        <li>Booking reference: <strong id="cashPaymentReference">-</strong></li>
                                    </ul>
                                    
                                    <div class="alert alert-warning">
                                        <strong>‚ö†Ô∏è Important:</strong> 
                                        <ul class="mb-0">
                                            <li>Your booking will be automatically cancelled if payment is not made within 24 hours of arrival</li>
                                            <li>Please bring a valid government-issued photo ID</li>
                                            <li>Late arrivals (after 10 PM) should inform the hotel in advance</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button type="button" id="confirmCashPaymentBtn" class="btn btn-success form-control" onclick="confirmCashPayment()">
                                            ‚úÖ Confirm Booking - Pay at Hotel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms and Security Info -->
                        <div class="form-group">
                            <div class="card">
                                <div class="card-body">
                                    <h4>üîí Security & Terms</h4>
                                    <div style="font-size: 0.9rem; line-height: 1.4;">
                                        <p><strong>Security:</strong> All payments are processed through SSL encrypted connections. Your card details are never stored on our servers.</p>
                                        <p><strong>Refunds:</strong> Cancellations made 24+ hours before check-in are eligible for full refund. Processing time: 3-5 business days.</p>
                                        <p><strong>Booking Policy:</strong> By proceeding with payment, you agree to our terms and conditions and cancellation policy.</p>
                                        <p><strong>Support:</strong> For payment issues, contact us at <strong>support@goldpalmhotel.com</strong> or <strong>+94 11 1234567</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Summary Sidebar -->
                <div class="booking-summary">
                    <h3>üí∞ Payment Summary</h3>
                    
                    <div id="paymentSummaryContent">
                        <div id="paymentSummaryPlaceholder" class="text-center">
                            <p>Loading payment details...</p>
                            <div class="spinner"></div>
                        </div>
                        
                        <div id="paymentSummaryDetails" style="display: none;">
                            <!-- Room Details -->
                            <div class="summary-section">
                                <h4>üè® Booking Details</h4>
                                <div class="summary-item">
                                    <span>Room:</span>
                                    <span id="summaryRoomType">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Dates:</span>
                                    <span id="summaryDates">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Guests:</span>
                                    <span id="summaryGuests">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Duration:</span>
                                    <span id="summaryNights">-</span>
                                </div>
                            </div>
                            
                            <!-- Price Breakdown -->
                            <div class="summary-section">
                                <h4>üíµ Price Breakdown</h4>
                                <div class="summary-item">
                                    <span>Room rate:</span>
                                    <span id="summaryRoomRate">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Subtotal:</span>
                                    <span id="summarySubtotal">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Service charge (10%):</span>
                                    <span id="summaryServiceCharge">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Taxes (2%):</span>
                                    <span id="summaryTaxes">-</span>
                                </div>
                            </div>
                            
                            <!-- Total -->
                            <div class="total-amount">
                                <div class="summary-item">
                                    <span>Total Amount:</span>
                                    <span id="summaryTotal">LKR 0.00</span>
                                </div>
                            </div>
                            
                            <!-- Payment Security -->
                            <div class="mt-2">
                                <div class="alert alert-success" style="padding: 0.75rem; font-size: 0.9rem;">
                                    <strong>üîí 100% Secure</strong><br>
                                    SSL encrypted<br>
                                    PCI DSS compliant<br>
                                    No card details stored
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </section>
</div>
    
    <!-- Additional JavaScript for payment page -->
    <th:block th:fragment="additional-js">
        <script>
            let currentBookingData = null;
            let selectedPaymentMethod = 'CREDIT_CARD';
            
            // Global error handler
            window.addEventListener('error', function(e) {
                console.error('JavaScript error on payment page:', e.error);
                console.error('Error details:', e.filename, e.lineno, e.colno);
            });
            
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Payment page DOM loaded, starting initialization');
                
                // Extra safety check - only run payment JavaScript if we're actually on payment page
                if (window.location.pathname !== '/payment') {
                    console.log('Payment JavaScript attempted to run on wrong page:', window.location.pathname);
                    return;
                }
                
                // Check if we have any indication that we should be on this page
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('bookingId');
                const pendingBooking = JSON.parse(sessionStorage.getItem('pendingBooking') || '{}');
                
                if (!bookingId && !pendingBooking.bookingId) {
                    console.log('Payment page accessed without valid booking data');
                    
                    // Check for redirect loop
                    const redirectCount = sessionStorage.getItem('redirectCount') || '0';
                    const lastPage = sessionStorage.getItem('lastPage');
                    
                    if (lastPage === 'rooms' && parseInt(redirectCount) > 3) {
                        console.log('Detected redirect loop from payment page, breaking');
                        sessionStorage.clear();
                        alert('There seems to be a navigation issue. Please refresh the page and try again.');
                        return;
                    }
                    
                    sessionStorage.setItem('lastPage', 'payment');
                    sessionStorage.setItem('redirectCount', String(parseInt(redirectCount) + 1));
                    
                    console.log('Redirecting to rooms page');
                    window.location.replace('/rooms');
                    return;
                }
                
                try {
                    loadBookingData();
                    initializePaymentMethods();
                } catch (error) {
                    console.error('Error during payment page initialization:', error);
                }
                
                // The payment button will be enabled by form validation in the custom payment system
            });
            
            function loadBookingData() {
                console.log('Payment page: loadBookingData called');
                console.log('Payment page: Current URL:', window.location.href);
                console.log('Payment page: Referrer:', document.referrer);
                
                // Get booking ID from URL or session storage
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('bookingId');
                
                console.log('Payment page: bookingId from URL:', bookingId);
                
                if (bookingId) {
                    fetchBookingData(bookingId);
                } else {
                    // Try to get from session storage
                    const pendingBooking = JSON.parse(sessionStorage.getItem('pendingBooking') || '{}');
                    console.log('Payment page: pendingBooking from session:', pendingBooking);
                    
                    if (pendingBooking.bookingId) {
                        fetchBookingData(pendingBooking.bookingId);
                    } else {
                        console.log('Payment page: No booking found in loadBookingData');
                        // Don't show alert or redirect here as we already handled it above
                        console.log('This should not happen if the pre-checks worked correctly');
                    }
                }
            }
            
            function fetchBookingData(bookingId) {
                console.log('Payment page: Fetching booking data for ID:', bookingId);
                fetch(`/api/bookings/${bookingId}`)
                    .then(response => {
                        console.log('Payment page: API response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Booking not found');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Payment page: Booking data received:', data);
                        currentBookingData = data;
                        displayBookingInfo(data);
                        displayPaymentSummary(data);
                        setupPaymentForm(data);
                    })
                    .catch(error => {
                        console.error('Error loading booking:', error);
                        showAlert('Error loading booking information. Please try again.', 'error');
                    });
            }
            
            function displayBookingInfo(booking) {
                document.getElementById('bookingInfoPlaceholder').style.display = 'none';
                document.getElementById('bookingDetails').style.display = 'block';
                
                document.getElementById('bookingReference').textContent = booking.bookingReference;
                document.getElementById('roomDetails').textContent = `${booking.roomNumber} (${booking.roomTypeName})`;
                document.getElementById('guestName').textContent = booking.customerName;
                document.getElementById('checkInDisplay').textContent = formatDate(booking.checkInDate);
                document.getElementById('checkOutDisplay').textContent = formatDate(booking.checkOutDate);
                document.getElementById('durationDisplay').textContent = `${booking.numberOfNights} night${booking.numberOfNights !== 1 ? 's' : ''}`;
            }
            
            function displayPaymentSummary(booking) {
                document.getElementById('paymentSummaryPlaceholder').style.display = 'none';
                document.getElementById('paymentSummaryDetails').style.display = 'block';
                
                const subtotal = booking.roomPricePerNight * booking.numberOfNights;
                const serviceCharge = subtotal * 0.10;
                const taxes = subtotal * 0.02;
                
                document.getElementById('summaryRoomType').textContent = booking.roomTypeName;
                document.getElementById('summaryDates').textContent = `${formatDateShort(booking.checkInDate)} - ${formatDateShort(booking.checkOutDate)}`;
                document.getElementById('summaryGuests').textContent = `${booking.numberOfGuests} guest${booking.numberOfGuests !== 1 ? 's' : ''}`;
                document.getElementById('summaryNights').textContent = `${booking.numberOfNights} night${booking.numberOfNights !== 1 ? 's' : ''}`;
                document.getElementById('summaryRoomRate').textContent = `${formatCurrency(booking.roomPricePerNight)} √ó ${booking.numberOfNights}`;
                document.getElementById('summarySubtotal').textContent = formatCurrency(subtotal);
                document.getElementById('summaryServiceCharge').textContent = formatCurrency(serviceCharge);
                document.getElementById('summaryTaxes').textContent = formatCurrency(taxes);
                document.getElementById('summaryTotal').textContent = formatCurrency(booking.totalAmount);
                
                // Update all amount displays
                document.getElementById('paymentAmount').textContent = formatCurrency(booking.totalAmount);
                document.getElementById('bankTransferAmount').textContent = formatCurrency(booking.totalAmount);
                document.getElementById('cashPaymentAmount').textContent = formatCurrency(booking.totalAmount);
                document.getElementById('bankTransferReference').textContent = booking.bookingReference;
                document.getElementById('cashPaymentReference').textContent = booking.bookingReference;
            }
            
            function setupPaymentForm(booking) {
                console.log('Payment page: Setting up custom payment form with booking:', booking);
                
                // Setup custom payment form
                document.getElementById('bookingReferenceField').value = booking.bookingReference;
                document.getElementById('paymentAmountField').value = booking.totalAmount.toFixed(2);
                
                console.log('Payment page: Custom payment form fields populated');
                
                // Payment button will be enabled by form validation
                console.log('Payment page: Payment form ready');
            }
            
            function initializePaymentMethods() {
                selectPaymentMethod('CREDIT_CARD');
                setupCreditCardForm();
            }
            
            function selectPaymentMethod(method) {
                selectedPaymentMethod = method;
                
                // Update UI
                document.querySelectorAll('.payment-method').forEach(el => {
                    el.classList.remove('selected');
                });
                document.querySelector(`[data-method="${method}"]`).classList.add('selected');
                
                // Show/hide payment sections
                document.getElementById('creditCardPaymentSection').style.display = method === 'CREDIT_CARD' ? 'block' : 'none';
                document.getElementById('bankTransferSection').style.display = method === 'BANK_TRANSFER' ? 'block' : 'none';
                document.getElementById('cashPaymentSection').style.display = method === 'CASH' ? 'block' : 'none';
            }
            
            function setupCreditCardForm() {
                const form = document.getElementById('creditCardPaymentForm');
                if (!form) return;
                
                // Add input formatting
                const cardNumberInput = document.getElementById('cardNumber');
                const expiryDateInput = document.getElementById('expiryDate');
                const cvvInput = document.getElementById('cvv');
                
                // Format card number with spaces
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || '';
                    e.target.value = formattedValue;
                });
                
                // Format expiry date with slash
                expiryDateInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
                
                // Restrict CVV to numbers only
                cvvInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
                
                // Enable/disable pay button based on form validity
                form.addEventListener('input', function() {
                    const payBtn = document.getElementById('payNowBtn');
                    const termsCheckbox = document.getElementById('termsAccepted');
                    const isValid = form.checkValidity() && termsCheckbox.checked;
                    payBtn.disabled = !isValid;
                });
                
                // Handle form submission
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (form.checkValidity()) {
                        processCustomPayment();
                    } else {
                        form.classList.add('was-validated');
                    }
                });
            }
            
            function processCustomPayment() {
                const form = document.getElementById('creditCardPaymentForm');
                const formData = new FormData(form);
                
                const paymentData = {
                    bookingReference: currentBookingData.bookingReference,
                    cardNumber: formData.get('cardNumber'),
                    expiryDate: formData.get('expiryDate'),
                    cvv: formData.get('cvv'),
                    cardholderName: formData.get('cardholderName'),
                    amount: currentBookingData.totalAmount
                };
                
                // Show loading
                document.getElementById('paymentProgress').style.display = 'block';
                document.getElementById('payNowBtn').disabled = true;
                
                fetch('/api/custom-payment/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value || ''
                    },
                    body: JSON.stringify(paymentData)
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('paymentProgress').style.display = 'none';
                    
                    if (data.success) {
                        showAlert('Payment successful! Redirecting to confirmation...', 'success');
                        setTimeout(() => {
                            window.location.href = '/payment/success?order_id=' + data.bookingReference;
                        }, 2000);
                    } else {
                        showAlert(data.error || 'Payment failed. Please try again.', 'error');
                        document.getElementById('payNowBtn').disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);
                    document.getElementById('paymentProgress').style.display = 'none';
                    document.getElementById('payNowBtn').disabled = false;
                    showAlert('Payment processing failed. Please try again.', 'error');
                });
            }
            
            function confirmBankTransfer() {
                if (confirm('Please confirm that you will transfer the payment and send proof to our email. Your booking will be on hold until payment is verified.')) {
                    processAlternativePayment('BANK_TRANSFER');
                }
            }
            
            function confirmCashPayment() {
                if (confirm('Please confirm that you will pay at the hotel during check-in. Your booking will be held for 24 hours from your arrival time.')) {
                    processAlternativePayment('CASH');
                }
            }
            
            function processAlternativePayment(paymentMethod) {
                showLoading('Processing your booking...');
                
                fetch('/api/payment/alternative', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value || ''
                    },
                    body: JSON.stringify({
                        bookingId: currentBookingData.bookingId,
                        paymentMethod: paymentMethod
                    })
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showAlert('Booking confirmed! You will receive a confirmation email shortly.', 'success');
                        setTimeout(() => {
                            window.location.href = '/booking/confirmation?bookingId=' + currentBookingData.bookingId;
                        }, 2000);
                    } else {
                        showAlert(data.error || 'Error processing payment. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Payment processing error:', error);
                    showAlert('Error processing payment. Please try again.', 'error');
                });
            }
            
            // Custom payment form is handled in setupCreditCardForm function
            
            function formatCurrency(amount) {
                return `LKR ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            // Test payment function removed - custom payment system handles validation internally
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            function formatDateShort(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        </script>
    </th:block>
    
    <!-- Additional CSS for payment page -->
    <th:block th:fragment="additional-css">
        <style>
            .payment-method {
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .payment-method:hover {
                background: #f8f9fa !important;
                border-color: #ffd700 !important;
                transform: translateY(-2px);
            }
            
            .payment-method.selected {
                background: #fff3cd !important;
                border-color: #ffd700 !important;
                box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
            }
            
            .sticky-top {
                top: 2rem;
            }
        </style>
    </th:block>
</body>
</html>