<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promotion Management - Gold Palm Hotel Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/admin-style.css" rel="stylesheet">
    <style>
        .promotion-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .discount-badge {
            font-size: 0.9rem;
        }
        .expiry-soon {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Admin Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-gradient-card sidebar collapse">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Admin Panel</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/dashboard">
                                <i class="bi bi-house-door"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/bookings">
                                <i class="bi bi-calendar-check"></i> Bookings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/rooms">
                                <i class="bi bi-building"></i> Rooms
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin/promotions">
                                <i class="bi bi-tags"></i> Promotions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/staff">
                                <i class="bi bi-people"></i> Staff
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/logout">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Promotion Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="/admin/promotions/create" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Create New Promotion
                        </a>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-bg-primary">
                            <div class="card-body">
                                <h5 class="card-title">Active Promotions</h5>
                                <h3 class="card-text" th:text="${activePromotionsCount}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-bg-success">
                            <div class="card-body">
                                <h5 class="card-title">Valid Promotions</h5>
                                <h3 class="card-text" th:text="${validPromotionsCount}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-bg-warning">
                            <div class="card-body">
                                <h5 class="card-title">Expiring Soon</h5>
                                <h3 class="card-text" th:text="${#lists.size(expiringSoonPromotions)}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-bg-info">
                            <div class="card-body">
                                <h5 class="card-title">Total Promotions</h5>
                                <h3 class="card-text" th:text="${promotionsPage.totalElements}">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expiring Soon Alert -->
                <div th:if="${not #lists.isEmpty(expiringSoonPromotions)}" class="alert alert-warning expiry-soon mb-4">
                    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Promotions Expiring Soon</h6>
                    <div class="row">
                        <div th:each="promo : ${expiringSoonPromotions}" class="col-md-4 mb-2">
                            <small>
                                <strong th:text="${promo.promoCode}"></strong> -
                                <span th:text="${promo.title}"></span>
                                <br>
                                <em>Expires: <span th:text="${#temporals.format(promo.endDate, 'MMM dd, yyyy')}"></span></em>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Success/Error Messages -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
                    <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
                    <i class="bi bi-exclamation-circle"></i> <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <form th:action="@{/admin/promotions}" method="get" class="d-flex">
                            <input type="text" class="form-control me-2" name="search" th:value="${search}"
                                   placeholder="Search promotions by title, code, or description...">
                            <button class="btn btn-outline-secondary" type="submit">
                                <i class="bi bi-search"></i> Search
                            </button>
                            <a th:if="${search != null and not #strings.isEmpty(search)}" href="/admin/promotions"
                               class="btn btn-outline-secondary ms-2">
                                <i class="bi bi-x-circle"></i> Clear
                            </a>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                Bulk Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="bulkAction('activate')">
                                    <i class="bi bi-toggle-on"></i> Activate Selected
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="bulkAction('deactivate')">
                                    <i class="bi bi-toggle-off"></i> Deactivate Selected
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="bulkAction('delete')">
                                    <i class="bi bi-trash"></i> Delete Selected
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Promotions Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th><input type="checkbox" id="selectAll"></th>
                                        <th>Image</th>
                                        <th>
                                            <a th:href="@{/admin/promotions(search=${search}, sortBy='promoCode', sortDir=${sortBy == 'promoCode' ? reverseSortDir : 'asc'})}"
                                               class="text-white text-decoration-none">
                                                Promo Code
                                                <i th:if="${sortBy == 'promoCode'}"
                                                   th:class="${sortDir == 'asc' ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-up'}"></i>
                                            </a>
                                        </th>
                                        <th>
                                            <a th:href="@{/admin/promotions(search=${search}, sortBy='title', sortDir=${sortBy == 'title' ? reverseSortDir : 'asc'})}"
                                               class="text-white text-decoration-none">
                                                Title
                                                <i th:if="${sortBy == 'title'}"
                                                   th:class="${sortDir == 'asc' ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-up'}"></i>
                                            </a>
                                        </th>
                                        <th>Discount</th>
                                        <th>Valid Period</th>
                                        <th>Usage</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="promotion : ${promotionsPage.content}" th:id="'promotion-' + ${promotion.promotionId}">
                                        <td><input type="checkbox" class="promotion-checkbox" th:value="${promotion.promotionId}"></td>
                                        <td>
                                            <img th:if="${promotion.imagePath != null}"
                                                 th:src="${promotion.imagePath}"
                                                 class="promotion-image"
                                                 th:alt="${promotion.title}">
                                            <div th:unless="${promotion.imagePath != null}"
                                                 class="promotion-image bg-gradient-card d-flex align-items-center justify-content-center border-gradient">
                                                <i class="bi bi-image text-muted"></i>
                                            </div>
                                        </td>
                                        <td>
                                            <strong th:text="${promotion.promoCode}"></strong>
                                        </td>
                                        <td>
                                            <div th:text="${promotion.title}"></div>
                                            <small class="text-muted" th:if="${promotion.description != null}"
                                                   th:text="${#strings.abbreviate(promotion.description, 50)}"></small>
                                        </td>
                                        <td>
                                            <span th:if="${promotion.discountType.name() == 'PERCENTAGE'}"
                                                  class="badge bg-success discount-badge">
                                                <span th:text="${promotion.discountValue}"></span>% OFF
                                            </span>
                                            <span th:unless="${promotion.discountType.name() == 'PERCENTAGE'}"
                                                  class="badge bg-info discount-badge">
                                                LKR <span th:text="${#numbers.formatInteger(promotion.discountValue, 0, 'COMMA')}"></span> OFF
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                <strong>Start:</strong> <span th:text="${#temporals.format(promotion.startDate, 'MMM dd, yyyy')}"></span><br>
                                                <strong>End:</strong> <span th:text="${#temporals.format(promotion.endDate, 'MMM dd, yyyy')}"></span>
                                            </small>
                                        </td>
                                        <td>
                                            <small>
                                                <span th:text="${promotion.usageCount != null ? promotion.usageCount : 0}"></span>
                                                <span th:if="${promotion.usageLimit != null}">
                                                    / <span th:text="${promotion.usageLimit}"></span>
                                                </span>
                                                <span th:unless="${promotion.usageLimit != null}">/ ∞</span>
                                            </small>
                                        </td>
                                        <td>
                                            <span th:if="${promotion.isActive}" class="badge bg-success status-badge">Active</span>
                                            <span th:unless="${promotion.isActive}" class="badge bg-secondary status-badge">Inactive</span>
                                            <br>
                                            <small th:if="${promotion.currentlyActive}" class="text-success">
                                                <i class="bi bi-check-circle"></i> Valid Now
                                            </small>
                                            <small th:unless="${promotion.currentlyActive}" class="text-muted">
                                                <i class="bi bi-clock"></i> Not Current
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical btn-group-sm" role="group">
                                                <a th:href="@{'/admin/promotions/view/' + ${promotion.promotionId}}"
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-eye"></i> View
                                                </a>
                                                <a th:href="@{'/admin/promotions/edit/' + ${promotion.promotionId}}"
                                                   class="btn btn-outline-secondary btn-sm">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </a>
                                                <button class="btn btn-outline-warning btn-sm"
                                                        th:data-promotion-id="${promotion.promotionId}"
                                                        onclick="toggleStatus(this.getAttribute('data-promotion-id'))">
                                                    <i class="bi bi-toggle-on" th:if="${promotion.isActive}"></i>
                                                    <i class="bi bi-toggle-off" th:unless="${promotion.isActive}"></i>
                                                    Toggle
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm"
                                                        th:data-promotion-id="${promotion.promotionId}"
                                                        th:data-promotion-title="${promotion.title}"
                                                        onclick="deletePromotion(this.getAttribute('data-promotion-id'), this.getAttribute('data-promotion-title'))">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${promotionsPage.content.size() == 0}" class="text-center py-5">
                            <i class="bi bi-tags display-4 text-muted"></i>
                            <h4 class="mt-3 text-muted">No Promotions Found</h4>
                            <p class="text-muted">
                                <span th:if="${search != null and not #strings.isEmpty(search)}">
                                    No promotions match your search criteria.
                                </span>
                                <span th:unless="${search != null and not #strings.isEmpty(search)}">
                                    Get started by creating your first promotion.
                                </span>
                            </p>
                            <a href="/admin/promotions/create" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Create First Promotion
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav th:if="${promotionsPage.totalPages > 1}" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${promotionsPage.first} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/promotions(page=${promotionsPage.number - 1}, search=${search}, sortBy=${sortBy}, sortDir=${sortDir})}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>

                        <li th:each="pageNum : ${#numbers.sequence(0, promotionsPage.totalPages - 1)}"
                            class="page-item"
                            th:classappend="${pageNum == promotionsPage.number} ? 'active'">
                            <a class="page-link" th:href="@{/admin/promotions(page=${pageNum}, search=${search}, sortBy=${sortBy}, sortDir=${sortDir})}"
                               th:text="${pageNum + 1}">1</a>
                        </li>

                        <li class="page-item" th:classappend="${promotionsPage.last} ? 'disabled'">
                            <a class="page-link" th:href="@{/admin/promotions(page=${promotionsPage.number + 1}, search=${search}, sortBy=${sortBy}, sortDir=${sortDir})}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- Bulk Action Form -->
    <form id="bulkActionForm" method="post" action="/admin/promotions/bulk-action" style="display: none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" name="action" id="bulkAction">
        <input type="hidden" name="promotionIds" id="bulkPromotionIds">
    </form>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the promotion <strong id="deletePromotionName"></strong>?</p>
                    <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="post" style="display: inline;" th:action="@{/admin/promotions/delete/1}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        // Get CSRF token
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';

        // Select All functionality
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.promotion-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        });

        // Toggle promotion status
        function toggleStatus(promotionId) {
            if (confirm('Are you sure you want to toggle the status of this promotion?')) {
                const headers = {
                    'Content-Type': 'application/json',
                };
                headers[csrfHeader] = csrfToken;

                fetch('/admin/promotions/toggle-status/' + promotionId, {
                    method: 'POST',
                    headers: headers
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the promotion status.');
                });
            }
        }

        // Delete promotion
        function deletePromotion(promotionId, promotionName) {
            document.getElementById('deletePromotionName').textContent = promotionName;
            document.getElementById('deleteForm').action = '/admin/promotions/delete/' + promotionId;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        // Bulk actions
        function bulkAction(action) {
            const checkboxes = document.querySelectorAll('.promotion-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one promotion.');
                return;
            }

            if (confirm('Are you sure you want to ' + action + ' ' + checkboxes.length + ' promotion(s)?')) {
                const promotionIds = Array.from(checkboxes).map(cb => cb.value);
                document.getElementById('bulkAction').value = action;
                document.getElementById('bulkPromotionIds').value = promotionIds.join(',');
                document.getElementById('bulkActionForm').submit();
            }
        }
    </script>
</body>
</html>