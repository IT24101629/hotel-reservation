<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Luxury Rooms - Golden Palm Hotel</title>
</head>
<body>
<div th:fragment="content">
    <!-- Hero Section -->
    <section class="hero-section bg-dark">
        <div class="container">
            <div class="text-center">
                <div class="fade-in-up">
                    <h1 class="display-4 mb-6 text-golden">
                        <i class="fas fa-bed me-3"></i>
                        Luxury Accommodations
                    </h1>
                </div>
                <div class="fade-in-up" style="animation-delay: 0.2s;">
                    <p class="lead mb-8">
                        Discover our premium collection of elegantly appointed rooms and suites,
                        designed for ultimate comfort and sophistication.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Room Search Section -->
    <section class="py-5">
        <div class="container">
            <div class="card shadow-glow">
                <div class="card-header text-center">
                    <h2 class="mb-0">
                        <i class="fas fa-search text-golden me-3"></i>
                        Find Your Perfect Room
                    </h2>
                    <p class="mt-3 mb-0">Search and filter available rooms for your stay</p>
                </div>
                <div class="card-body p-5">
                    <form id="roomSearchForm" method="get">
                        <div class="row g-4">
                            <div class="col-md-6 col-lg-3">
                                <div class="form-floating">
                                    <input type="date"
                                           id="checkInDate"
                                           name="checkInDate"
                                           class="form-control form-control-modern"
                                           th:value="${checkIn}"
                                           required>
                                    <label for="checkInDate">
                                        <i class="fas fa-calendar-check me-2"></i>Check-in Date
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="form-floating">
                                    <input type="date"
                                           id="checkOutDate"
                                           name="checkOutDate"
                                           class="form-control form-control-modern"
                                           th:value="${checkOut}"
                                           required>
                                    <label for="checkOutDate">
                                        <i class="fas fa-calendar-times me-2"></i>Check-out Date
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="form-floating">
                                    <select id="guests" name="guests" class="form-select form-control-modern" required>
                                        <option value="">Select</option>
                                        <option value="1" th:selected="${guests == 1}">1 Guest</option>
                                        <option value="2" th:selected="${guests == 2}">2 Guests</option>
                                        <option value="3" th:selected="${guests == 3}">3 Guests</option>
                                        <option value="4" th:selected="${guests == 4}">4 Guests</option>
                                        <option value="5" th:selected="${guests == 5}">5 Guests</option>
                                        <option value="6" th:selected="${guests == 6}">6 Guests</option>
                                    </select>
                                    <label for="guests">
                                        <i class="fas fa-users me-2"></i>Number of Guests
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <div class="form-floating">
                                    <select id="roomType" name="roomType" class="form-select form-control-modern">
                                        <option value="">Any Type</option>
                                        <option value="Standard Single" th:selected="${roomType == 'Standard Single'}">Standard Single</option>
                                        <option value="Standard Double" th:selected="${roomType == 'Standard Double'}">Standard Double</option>
                                        <option value="Deluxe Room" th:selected="${roomType == 'Deluxe Room'}">Deluxe Room</option>
                                        <option value="Family Suite" th:selected="${roomType == 'Family Suite'}">Family Suite</option>
                                        <option value="Presidential Suite" th:selected="${roomType == 'Presidential Suite'}">Presidential Suite</option>
                                    </select>
                                    <label for="roomType">
                                        <i class="fas fa-bed me-2"></i>Room Type
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button type="submit" id="searchRoomsBtn" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-search me-2"></i>
                                Search Available Rooms
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Available Rooms Section -->
    <section class="py-5" id="roomListing">
        <div class="container">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-golden" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Searching available rooms...</p>
            </div>

            <!-- Search Results Container -->
            <div id="searchResults" class="row g-4">
                <!-- Available rooms will be displayed here -->
                <div th:each="room : ${availableRooms}" class="col-lg-6 col-xl-4 fade-in-up">
                    <div class="card h-100 shadow-glow room-card">
                        <div class="position-relative">
                            <th:block>
                                <img th:src="${imgUrl}"
                                     th:alt="${room.roomType.typeName}"
                                     class="card-img-top"
                                     style="height: 250px; object-fit: cover;"
                                     onerror="this.src='/images/room-default.jpg'">
                            </th:block>
                            <div class="position-absolute top-0 end-0 m-3">
                                <span class="badge bg-golden text-dark fs-6 px-3 py-2">
                                    <i class="fas fa-users me-1"></i>
                                    <span th:text="${room.roomType.maxOccupancy}">2</span>
                                </span>
                            </div>
                            <div class="position-absolute bottom-0 end-0 m-3">
                                <span class="badge bg-primary fs-6 px-3 py-2">
                                    LKR <span th:text="${#numbers.formatDecimal(room.pricePerNight, 1, 2)}">0.00</span>/night
                                </span>
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-golden" th:text="${room.roomType.typeName}">Room Type</h5>
                            <p class="card-text flex-grow-1" th:text="${room.description}">Room description</p>

                            <div class="room-details mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-door-open text-golden me-1"></i>
                                        Room <span th:text="${room.roomNumber}">101</span>
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-building text-golden me-1"></i>
                                        Floor <span th:text="${room.floorNumber}">1</span>
                                    </small>
                                </div>
                            </div>

                            <div class="amenities mb-3">
                                <h6 class="text-golden mb-2">
                                    <i class="fas fa-star me-2"></i>Amenities
                                </h6>
                                <div class="d-flex flex-wrap gap-1">
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-wifi me-1"></i>WiFi
                                    </span>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-snowflake me-1"></i>AC
                                    </span>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-tv me-1"></i>TV
                                    </span>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-bath me-1"></i>Bathroom
                                    </span>
                                </div>
                            </div>

                            <div class="mt-auto">
                                <button class="btn btn-primary w-100 book-room-btn"
                                        th:data-room-id="${room.roomId}"
                                        th:data-room-number="${room.roomNumber}"
                                        th:data-price="${room.pricePerNight}"
                                        th:data-room-type="${room.roomType.typeName}"
                                        th:data-max-occupancy="${room.roomType.maxOccupancy}"
                                        sec:authorize="isAuthenticated()">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    Book This Room
                                </button>
                                <a href="/auth/login" class="btn btn-outline-primary w-100" sec:authorize="isAnonymous()">
                                    <i class="fas fa-sign-in-alt me-2"></i>
                                    Login to Book
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="text-center py-5" th:if="${availableRooms != null && availableRooms.isEmpty()}">
                <div class="card shadow-glow">
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <i class="fas fa-bed text-golden display-1"></i>
                        </div>
                        <h3 class="text-golden">No Available Rooms</h3>
                        <p class="lead">Sorry, no rooms match your search criteria. Please try adjusting your dates or preferences.</p>
                        <a href="/rooms" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i>View All Rooms
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Additional JavaScript for rooms page -->
<th:block th:fragment="additional-js">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're actually on the rooms page
            if (!window.location.pathname.includes('/rooms')) {
                return;
            }
            function imageForRoom(room) {
                if (room.imageUrl && room.imageUrl.trim()) return room.imageUrl;
                const map = {
                    'Standard Single': '/images/rooms/standard-single.jpg',
                    'Standard Double': '/images/rooms/standard-double.jpg',
                    'Deluxe Room': '/images/rooms/deluxe.jpg',
                    'Family Suite': '/images/rooms/family-suite.jpg',
                    'Presidential Suite': '/images/rooms/presidential-suite.jpg'
                };
                return map[room.roomType] || '/images/room-default.jpg';
            }

            console.log('Rooms page JavaScript loading...');

            // Debug session storage state
            console.log('Session storage state on rooms page:');
            console.log('- selectedRoomData:', sessionStorage.getItem('selectedRoomData'));
            console.log('- bookingData:', sessionStorage.getItem('bookingData'));
            console.log('- pendingBooking:', sessionStorage.getItem('pendingBooking'));

            // Check if we're in a redirect loop and break it
            const redirectCount = sessionStorage.getItem('redirectCount') || '0';
            const lastPage = sessionStorage.getItem('lastPage');

            if (lastPage === 'payment' && parseInt(redirectCount) > 2) {
                console.log('Detected redirect loop, clearing all session data');
                sessionStorage.clear();
                sessionStorage.setItem('loopBroken', 'true');
            }

            sessionStorage.setItem('lastPage', 'rooms');
            sessionStorage.setItem('redirectCount', String(parseInt(redirectCount) + 1));

            // Clean up any stale session data that might cause issues
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('keepSession')) {
                // Only clear payment-related session data, keep room selection data
                sessionStorage.removeItem('bookingData');
                sessionStorage.removeItem('pendingBooking');
                console.log('Cleaned up stale session data');
            }

            initializeRoomsPage();
        });

        function initializeRoomsPage() {
            console.log('Initializing rooms page...');
            initializeRoomSearch();
            initializeDatePickers();
            initializeBookingButtons();
        }

        function initializeBookingButtons() {
            console.log('Initializing booking buttons...');

            const bookButtons = document.querySelectorAll('.book-room-btn');
            console.log('Found', bookButtons.length, 'book room buttons');

            bookButtons.forEach((button, index) => {
                console.log('Setting up button', index, 'with data:', {
                    roomId: button.dataset.roomId,
                    roomNumber: button.dataset.roomNumber,
                    price: button.dataset.price,
                    roomType: button.dataset.roomType,
                    maxOccupancy: button.dataset.maxOccupancy
                });

                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Book room button clicked!');

                    try {
                        const roomId = this.dataset.roomId;
                        const roomNumber = this.dataset.roomNumber;
                        const pricePerNight = this.dataset.price;
                        const roomType = this.dataset.roomType;
                        const maxOccupancy = this.dataset.maxOccupancy;

                        console.log('Extracted values:', {roomId, roomNumber, pricePerNight, roomType, maxOccupancy});

                        if (!roomId) {
                            console.error('Missing room ID in dataset');
                            alert('Error: Room ID not found. Please refresh the page and try again.');
                            return;
                        }

                        // Get current search criteria
                        const checkInDate = document.getElementById('checkInDate')?.value || getDefaultCheckInDate();
                        const checkOutDate = document.getElementById('checkOutDate')?.value || getDefaultCheckOutDate();
                        const numberOfGuests = document.getElementById('guests')?.value || 2;

                        // Store selected room data
                        const selectedRoomData = {
                            roomId: parseInt(roomId),
                            roomNumber: roomNumber,
                            pricePerNight: parseFloat(pricePerNight),
                            roomType: roomType,
                            maxOccupancy: parseInt(maxOccupancy) || 4,
                            checkInDate: checkInDate,
                            checkOutDate: checkOutDate,
                            numberOfGuests: parseInt(numberOfGuests)
                        };

                        console.log('Storing room data:', selectedRoomData);
                        sessionStorage.setItem('selectedRoomData', JSON.stringify(selectedRoomData));

                        // Redirect to booking page
                        window.location.href = '/booking';

                    } catch (error) {
                        console.error('Error in booking button click handler:', error);
                        alert('An error occurred while booking the room. Please try again.');
                    }
                });
            });
        }

        function getDefaultCheckInDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        function getDefaultCheckOutDate() {
            const dayAfterTomorrow = new Date();
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            return dayAfterTomorrow.toISOString().split('T')[0];
        }

        function initializeRoomSearch() {
            const searchForm = document.getElementById('roomSearchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    performSearch();
                });
            }
        }

        function initializeDatePickers() {
            const today = new Date().toISOString().split('T')[0];
            const checkInDate = document.getElementById('checkInDate');
            const checkOutDate = document.getElementById('checkOutDate');

            if (checkInDate && checkOutDate) {
                checkInDate.min = today;
                checkOutDate.min = today;

                // Set default dates if not already set
                if (!checkInDate.value) {
                    checkInDate.value = today;
                }
                if (!checkOutDate.value) {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    checkOutDate.value = tomorrow.toISOString().split('T')[0];
                }

                checkInDate.addEventListener('change', function() {
                    checkOutDate.min = this.value;
                    if (checkOutDate.value && checkOutDate.value <= this.value) {
                        const nextDay = new Date(this.value);
                        nextDay.setDate(nextDay.getDate() + 1);
                        checkOutDate.value = nextDay.toISOString().split('T')[0];
                    }
                });
            }
        }

        function performSearch() {
            try {
                const searchForm = document.getElementById('roomSearchForm');
                if (!searchForm) {
                    console.error('Search form not found');
                    showAlert('Search form not found. Please refresh the page.', 'error');
                    return;
                }

                const formData = new FormData(searchForm);
                const searchParams = new URLSearchParams();

                for (let [key, value] of formData.entries()) {
                    if (value) {
                        searchParams.append(key, value);
                    }
                }

                console.log('Performing search with params:', searchParams.toString());
                showLoading();

                fetch(`/api/rooms/search?${searchParams.toString()}`)
                    .then(response => {
                        console.log('Search response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Search results received:', data);
                        hideLoading();
                        displaySearchResults(data);
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert('Error searching rooms. Please try again.', 'error');
                        console.error('Search error:', error);
                    });
            } catch (error) {
                console.error('Error in performSearch:', error);
                showAlert('Error performing search. Please refresh the page and try again.', 'error');
            }
        }

        function displaySearchResults(rooms) {
            const resultsContainer = document.getElementById('searchResults');
            const noResultsContainer = document.getElementById('noResults');

            if (!resultsContainer) {
                console.error('Search results container not found');
                return;
            }

            if (rooms.length === 0) {
                if (noResultsContainer) noResultsContainer.style.display = 'flex';
                resultsContainer.style.display = 'none';
                return;
            }

            if (noResultsContainer) noResultsContainer.style.display = 'none';

            resultsContainer.innerHTML = rooms.map(room => `
                <div class="room-card-wrapper fade-in">
                    <div class="room-card">
                        <div class="room-image-container">
                            <img src="${room.imageUrl || '/images/room-default.jpg'}"
                                 alt="${room.roomType}"
                                 class="room-image"
                                 onerror="this.src='/images/room-default.jpg'">
                            <div class="room-overlay">
                                <div class="room-price-badge">
                                    <span class="price-amount">LKR ${room.pricePerNight.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                    <span class="price-period">/night</span>
                                </div>
                            </div>
                            <div class="room-capacity-badge">
                                <i class="fas fa-users me-2"></i>${room.maxOccupancy}
                            </div>
                        </div>

                        <div class="room-content">
                            <div class="room-header">
                                <h3 class="room-title">${room.roomType}</h3>
                                <p class="room-description">${room.description || ''}</p>
                            </div>

                            <div class="room-details">
                                <div class="detail-item">
                                    <i class="fas fa-door-open detail-icon"></i>
                                    <span class="detail-label">Room</span>
                                    <span class="detail-value">${room.roomNumber}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-building detail-icon"></i>
                                    <span class="detail-label">Floor</span>
                                    <span class="detail-value">${room.floorNumber}</span>
                                </div>
                            </div>

                            <div class="room-amenities">
                                <div class="amenities-header">
                                    <i class="fas fa-star me-2"></i>
                                    <span>Room Amenities</span>
                                </div>
                                <div class="amenities-grid">
                                    <div class="amenity-item">
                                        <i class="fas fa-wifi"></i>
                                        <span>WiFi</span>
                                    </div>
                                    <div class="amenity-item">
                                        <i class="fas fa-snowflake"></i>
                                        <span>AC</span>
                                    </div>
                                    <div class="amenity-item">
                                        <i class="fas fa-tv"></i>
                                        <span>TV</span>
                                    </div>
                                    <div class="amenity-item">
                                        <i class="fas fa-bath"></i>
                                        <span>Bathroom</span>
                                    </div>
                                </div>
                            </div>

                            <div class="room-actions">
                                <button class="btn-book-room dynamic-book-btn"
                                        data-room-id="${room.roomId}"
                                        data-room-number="${room.roomNumber}"
                                        data-price="${room.pricePerNight}"
                                        data-room-type="${room.roomType}"
                                        data-max-occupancy="${room.maxOccupancy}">
                                    <div class="btn-content">
                                        <i class="fas fa-calendar-check me-2"></i>
                                        <span>Book This Room</span>
                                    </div>
                                    <div class="btn-shimmer"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Re-attach event listeners for dynamically generated buttons
            attachDynamicButtonListeners();
            resultsContainer.style.display = 'grid';
        }

        function attachDynamicButtonListeners() {
            document.querySelectorAll('.dynamic-book-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();

                    try {
                        const roomId = this.dataset.roomId;
                        const roomNumber = this.dataset.roomNumber;
                        const pricePerNight = this.dataset.price;
                        const roomType = this.dataset.roomType;
                        const maxOccupancy = this.dataset.maxOccupancy;

                        if (!roomId) {
                            console.error('Missing room ID in dynamically generated button');
                            alert('Error: Room ID not found. Please try again.');
                            return;
                        }

                        // Get current search criteria
                        const checkInDate = document.getElementById('checkInDate')?.value || getDefaultCheckInDate();
                        const checkOutDate = document.getElementById('checkOutDate')?.value || getDefaultCheckOutDate();
                        const numberOfGuests = document.getElementById('guests')?.value || 2;

                        // Store selected room data
                        const selectedRoomData = {
                            roomId: parseInt(roomId),
                            roomNumber: roomNumber,
                            pricePerNight: parseFloat(pricePerNight),
                            roomType: roomType,
                            maxOccupancy: parseInt(maxOccupancy),
                            checkInDate: checkInDate,
                            checkOutDate: checkOutDate,
                            numberOfGuests: parseInt(numberOfGuests)
                        };

                        console.log('Storing dynamic room data:', selectedRoomData);
                        sessionStorage.setItem('selectedRoomData', JSON.stringify(selectedRoomData));

                        // Redirect to booking page
                        window.location.href = '/booking';

                    } catch (error) {
                        console.error('Error in dynamic booking button click handler:', error);
                        alert('An error occurred while booking the room. Please try again.');
                    }
                });
            });
        }


        function showLoading() {
            const spinner = document.getElementById('loadingSpinner');
            const results = document.getElementById('searchResults');
            if (spinner) spinner.style.display = 'flex';
            if (results) results.style.display = 'none';
        }

        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }

        function showAlert(message, type) {
            // Simple alert for now
            alert(message);
        }
    </script>
</th:block>

</body>
</html>