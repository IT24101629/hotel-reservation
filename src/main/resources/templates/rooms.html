<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Available Rooms - Hotel Reservation System</title>
</head>
<body>
<div th:fragment="content">
    <div class="container">
        <!-- Page Header -->
        <section class="mt-2 mb-3 text-center">
            <h1>🏨 Available Rooms</h1>
            <p>Discover our range of comfortable and luxurious accommodations</p>
        </section>

        <!-- Search and Filter Section -->
        <section class="search-container mb-3">
            <h2 class="text-center mb-2">🔍 Search & Filter Rooms</h2>
            <form id="roomSearchForm" class="search-form">
                <div class="form-group">
                    <label for="checkInDate">Check-in Date</label>
                    <input type="date"
                           id="checkInDate"
                           name="checkInDate"
                           class="form-control"
                           th:value="${checkIn}"
                           required>
                </div>

                <div class="form-group">
                    <label for="checkOutDate">Check-out Date</label>
                    <input type="date"
                           id="checkOutDate"
                           name="checkOutDate"
                           class="form-control"
                           th:value="${checkOut}"
                           required>
                </div>

                <div class="form-group">
                    <label for="guests">Number of Guests</label>
                    <select id="guests" name="guests" class="form-control" required>
                        <option value="">Select guests</option>
                        <option value="1" th:selected="${guests == 1}">1 Guest</option>
                        <option value="2" th:selected="${guests == 2}">2 Guests</option>
                        <option value="3" th:selected="${guests == 3}">3 Guests</option>
                        <option value="4" th:selected="${guests == 4}">4 Guests</option>
                        <option value="5" th:selected="${guests == 5}">5 Guests</option>
                        <option value="6" th:selected="${guests == 6}">6 Guests</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="roomType">Room Type</label>
                    <select id="roomType" name="roomType" class="form-control">
                        <option value="">Any Type</option>
                        <option value="Standard Single" th:selected="${roomType == 'Standard Single'}">Standard Single</option>
                        <option value="Standard Double" th:selected="${roomType == 'Standard Double'}">Standard Double</option>
                        <option value="Deluxe Room" th:selected="${roomType == 'Deluxe Room'}">Deluxe Room</option>
                        <option value="Family Suite" th:selected="${roomType == 'Family Suite'}">Family Suite</option>
                        <option value="Presidential Suite" th:selected="${roomType == 'Presidential Suite'}">Presidential Suite</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="submit" id="searchRoomsBtn" class="btn btn-primary form-control">🔍 Search Available Rooms</button>
                </div>
            </form>
        </section>

        <!-- Room Listing -->
        <section id="roomListing">
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center" style="display: none;">
                <div class="spinner"></div>
                <p>Searching available rooms...</p>
            </div>

            <!-- Search Results Container -->
            <div id="searchResults" class="rooms-grid">
                <!-- Available rooms will be displayed here -->
                <div th:each="room : ${availableRooms}" class="room-card">
                    <img th:src="${room.imageUrl != null ? room.imageUrl : '/images/room-default.jpg'}"
                         th:alt="${room.roomType.typeName}"
                         class="room-image"
                         onerror="this.src='/images/room-default.jpg'">
                    <div class="room-info">
                        <h3 class="room-title" th:text="${room.roomType.typeName}">Room Type</h3>
                        <p class="room-description" th:text="${room.description}">Room description</p>
                        <div class="room-details">
                            <p><strong>Room Number:</strong> <span th:text="${room.roomNumber}">101</span></p>
                            <p><strong>Floor:</strong> <span th:text="${room.floorNumber}">1</span></p>
                            <p><strong>Max Occupancy:</strong> <span th:text="${room.roomType.maxOccupancy}">2</span> guests</p>
                        </div>
                        <div class="room-amenities">
                            <!-- Static amenities for display -->
                            <span class="amenity-tag">📶 WiFi</span>
                            <span class="amenity-tag">❄️ AC</span>
                            <span class="amenity-tag">📺 TV</span>
                            <span class="amenity-tag">🛁 Private Bathroom</span>
                        </div>
                        <div class="room-price">
                            LKR <span th:text="${#numbers.formatDecimal(room.pricePerNight, 1, 2)}">0.00</span> / night
                        </div>
                        <div class="mt-2">
                            <!-- Fixed button using data attributes instead of onclick -->
                            <button class="btn btn-primary book-room-btn"
                                    th:data-room-id="${room.roomId}"
                                    th:data-room-number="${room.roomNumber}"
                                    th:data-price="${room.pricePerNight}"
                                    th:data-room-type="${room.roomType.typeName}"
                                    th:data-max-occupancy="${room.roomType.maxOccupancy}"
                                    sec:authorize="isAuthenticated()">
                                📅 Book This Room
                            </button>
                            <a href="/auth/login" class="btn btn-primary" sec:authorize="isAnonymous()">
                                🔑 Login to Book
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="text-center" th:if="${availableRooms != null && availableRooms.isEmpty()}">
                <div class="card">
                    <div class="card-body">
                        <h3>😔 No Available Rooms</h3>
                        <p>Sorry, no rooms match your search criteria. Please try adjusting your dates or preferences.</p>
                        <a href="/rooms" class="btn btn-primary">🔄 View All Rooms</a>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Additional JavaScript for rooms page -->
<th:block th:fragment="additional-js">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Rooms page JavaScript loading...');
            
            // Debug session storage state
            console.log('Session storage state on rooms page:');
            console.log('- selectedRoomData:', sessionStorage.getItem('selectedRoomData'));
            console.log('- bookingData:', sessionStorage.getItem('bookingData'));
            console.log('- pendingBooking:', sessionStorage.getItem('pendingBooking'));
            
            // Check if we're in a redirect loop and break it
            const redirectCount = sessionStorage.getItem('redirectCount') || '0';
            const lastPage = sessionStorage.getItem('lastPage');
            
            if (lastPage === 'payment' && parseInt(redirectCount) > 2) {
                console.log('Detected redirect loop, clearing all session data');
                sessionStorage.clear();
                sessionStorage.setItem('loopBroken', 'true');
            }
            
            sessionStorage.setItem('lastPage', 'rooms');
            sessionStorage.setItem('redirectCount', String(parseInt(redirectCount) + 1));
            
            // Clean up any stale session data that might cause issues
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('keepSession')) {
                // Only clear payment-related session data, keep room selection data
                sessionStorage.removeItem('bookingData');
                sessionStorage.removeItem('pendingBooking');
                console.log('Cleaned up stale session data');
            }
            
            initializeRoomsPage();
        });

        function initializeRoomsPage() {
            console.log('Initializing rooms page...');
            initializeRoomSearch();
            initializeDatePickers();
            initializeBookingButtons();
        }

        function initializeBookingButtons() {
            console.log('Initializing booking buttons...');

            const bookButtons = document.querySelectorAll('.book-room-btn');
            console.log('Found', bookButtons.length, 'book room buttons');

            bookButtons.forEach((button, index) => {
                console.log('Setting up button', index, 'with data:', {
                    roomId: button.dataset.roomId,
                    roomNumber: button.dataset.roomNumber,
                    price: button.dataset.price,
                    roomType: button.dataset.roomType,
                    maxOccupancy: button.dataset.maxOccupancy
                });

                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Book room button clicked!');

                    try {
                        const roomId = this.dataset.roomId;
                        const roomNumber = this.dataset.roomNumber;
                        const pricePerNight = this.dataset.price;
                        const roomType = this.dataset.roomType;
                        const maxOccupancy = this.dataset.maxOccupancy;

                        console.log('Extracted values:', {roomId, roomNumber, pricePerNight, roomType, maxOccupancy});

                        if (!roomId) {
                            console.error('Missing room ID in dataset');
                            alert('Error: Room ID not found. Please refresh the page and try again.');
                            return;
                        }

                        // Get current search criteria or use default values
                        const checkInDate = document.getElementById('checkInDate')?.value || getDefaultCheckInDate();
                        const checkOutDate = document.getElementById('checkOutDate')?.value || getDefaultCheckOutDate();
                        const numberOfGuests = document.getElementById('guests')?.value || '2';
                        
                        // Log the booking attempt with current values
                        console.log('Booking with values:', {
                            checkInDate,
                            checkOutDate,
                            numberOfGuests,
                            fromForm: {
                                checkIn: document.getElementById('checkInDate')?.value,
                                checkOut: document.getElementById('checkOutDate')?.value,
                                guests: document.getElementById('guests')?.value
                            }
                        });

                        // Store selected room data
                        const selectedRoomData = {
                            roomId: parseInt(roomId),
                            roomNumber: roomNumber,
                            pricePerNight: parseFloat(pricePerNight),
                            roomType: roomType,
                            maxOccupancy: parseInt(maxOccupancy) || 4,
                            checkInDate: checkInDate,
                            checkOutDate: checkOutDate,
                            numberOfGuests: parseInt(numberOfGuests)
                        };

                        console.log('Storing room data:', selectedRoomData);
                        sessionStorage.setItem('selectedRoomData', JSON.stringify(selectedRoomData));

                        // Redirect to booking page
                        window.location.href = '/booking';

                    } catch (error) {
                        console.error('Error in booking button click handler:', error);
                        alert('An error occurred while booking the room. Please try again.');
                    }
                });
            });
        }

        function getDefaultCheckInDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            return tomorrow.toISOString().split('T')[0];
        }

        function getDefaultCheckOutDate() {
            const dayAfterTomorrow = new Date();
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            return dayAfterTomorrow.toISOString().split('T')[0];
        }

        function initializeRoomSearch() {
            const searchForm = document.getElementById('roomSearchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    performSearch();
                });
            }
        }

        function initializeDatePickers() {
            const today = new Date().toISOString().split('T')[0];
            const checkInDate = document.getElementById('checkInDate');
            const checkOutDate = document.getElementById('checkOutDate');

            if (checkInDate && checkOutDate) {
                checkInDate.min = today;
                checkOutDate.min = today;

                // Set default dates - check-in tomorrow, check-out day after tomorrow
                if (!checkInDate.value) {
                    checkInDate.value = getDefaultCheckInDate();
                }
                if (!checkOutDate.value) {
                    checkOutDate.value = getDefaultCheckOutDate();
                }
                
                // Set default guests if not already set
                const guestsSelect = document.getElementById('guests');
                if (guestsSelect && !guestsSelect.value) {
                    guestsSelect.value = '2';
                }

                checkInDate.addEventListener('change', function() {
                    checkOutDate.min = this.value;
                    if (checkOutDate.value && checkOutDate.value <= this.value) {
                        const nextDay = new Date(this.value);
                        nextDay.setDate(nextDay.getDate() + 1);
                        checkOutDate.value = nextDay.toISOString().split('T')[0];
                    }
                });
            }
        }

        function performSearch() {
            try {
                const formData = new FormData(document.getElementById('roomSearchForm'));
                const searchParams = new URLSearchParams();

                for (let [key, value] of formData.entries()) {
                    if (value) {
                        searchParams.append(key, value);
                    }
                }

                showLoading();

                fetch(`/api/rooms/search?${searchParams.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        hideLoading();
                        displaySearchResults(data);
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert('Error searching rooms. Please try again.', 'error');
                        console.error('Search error:', error);
                    });
            } catch (error) {
                console.error('Error in performSearch:', error);
                showAlert('Error performing search. Please refresh the page and try again.', 'error');
            }
        }

        function displaySearchResults(rooms) {
            const resultsContainer = document.getElementById('searchResults');

            if (rooms.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                resultsContainer.style.display = 'none';
                return;
            }

            document.getElementById('noResults').style.display = 'none';

            resultsContainer.innerHTML = rooms.map(room => `
                <div class="room-card fade-in">
                    <img src="${room.imageUrl || '/images/room-default.jpg'}" alt="${room.roomType}" class="room-image" onerror="this.src='/images/room-default.jpg'">
                    <div class="room-info">
                        <h3 class="room-title">${room.roomType}</h3>
                        <p class="room-description">${room.description || ''}</p>
                        <div class="room-details">
                            <p><strong>Room Number:</strong> ${room.roomNumber}</p>
                            <p><strong>Floor:</strong> ${room.floorNumber}</p>
                            <p><strong>Max Occupancy:</strong> ${room.maxOccupancy} guests</p>
                        </div>
                        <div class="room-amenities">
                            <span class="amenity-tag">📶 WiFi</span>
                            <span class="amenity-tag">❄️ AC</span>
                            <span class="amenity-tag">📺 TV</span>
                            <span class="amenity-tag">🛁 Private Bathroom</span>
                        </div>
                        <div class="room-price">LKR ${room.pricePerNight.toLocaleString('en-US', {minimumFractionDigits: 2})} / night</div>
                        <div class="mt-2">
                            <button class="btn btn-primary dynamic-book-btn"
                                    data-room-id="${room.roomId}"
                                    data-room-number="${room.roomNumber}"
                                    data-price="${room.pricePerNight}"
                                    data-room-type="${room.roomType}"
                                    data-max-occupancy="${room.maxOccupancy}">
                                📅 Book This Room
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Re-attach event listeners for dynamically generated buttons
            attachDynamicButtonListeners();
            resultsContainer.style.display = 'grid';
        }

        function attachDynamicButtonListeners() {
            document.querySelectorAll('.dynamic-book-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();

                    try {
                        const roomId = this.dataset.roomId;
                        const roomNumber = this.dataset.roomNumber;
                        const pricePerNight = this.dataset.price;
                        const roomType = this.dataset.roomType;
                        const maxOccupancy = this.dataset.maxOccupancy;

                        if (!roomId) {
                            console.error('Missing room ID in dynamically generated button');
                            alert('Error: Room ID not found. Please try again.');
                            return;
                        }

                        // Get current search criteria or use default values
                        const checkInDate = document.getElementById('checkInDate')?.value || getDefaultCheckInDate();
                        const checkOutDate = document.getElementById('checkOutDate')?.value || getDefaultCheckOutDate();
                        const numberOfGuests = document.getElementById('guests')?.value || '2';
                        
                        // Log the booking attempt with current values
                        console.log('Booking with values:', {
                            checkInDate,
                            checkOutDate,
                            numberOfGuests,
                            fromForm: {
                                checkIn: document.getElementById('checkInDate')?.value,
                                checkOut: document.getElementById('checkOutDate')?.value,
                                guests: document.getElementById('guests')?.value
                            }
                        });

                        // Store selected room data
                        const selectedRoomData = {
                            roomId: parseInt(roomId),
                            roomNumber: roomNumber,
                            pricePerNight: parseFloat(pricePerNight),
                            roomType: roomType,
                            maxOccupancy: parseInt(maxOccupancy),
                            checkInDate: checkInDate,
                            checkOutDate: checkOutDate,
                            numberOfGuests: parseInt(numberOfGuests)
                        };

                        console.log('Storing dynamic room data:', selectedRoomData);
                        sessionStorage.setItem('selectedRoomData', JSON.stringify(selectedRoomData));

                        // Redirect to booking page
                        window.location.href = '/booking';

                    } catch (error) {
                        console.error('Error in dynamic booking button click handler:', error);
                        alert('An error occurred while booking the room. Please try again.');
                    }
                });
            });
        }

        function showLoading() {
            const spinner = document.getElementById('loadingSpinner');
            const results = document.getElementById('searchResults');
            if (spinner) spinner.style.display = 'block';
            if (results) results.style.display = 'none';
        }

        function hideLoading() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }

        function showAlert(message, type) {
            // Simple alert for now
            alert(message);
        }
    </script>
</th:block>

<!-- Additional CSS for rooms page -->
<th:block th:fragment="additional-css">
    <style>
        .room-card {
            transition: all 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .room-details p {
            margin: 0.25rem 0;
            color: #666;
            font-size: 0.9rem;
        }

        .fade-in {
            animation: fadeInUp 0.6s ease;
        }

        @media (max-width: 768px) {
            .rooms-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</th:block>
</body>
</html>