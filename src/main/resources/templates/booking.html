<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Book Your Stay - Hotel Reservation System</title>
</head>
<body>
    <div th:fragment="content">
        <div class="container">
            <!-- Page Header -->
            <section class="mt-2 mb-3 text-center">
                <h1><i class="fas fa-calendar-check"></i> Complete Your Booking</h1>
                <p>You're just one step away from confirming your reservation</p>
            </section>
            
            <!-- Booking Container -->
            <div class="booking-container">
                <!-- Main Booking Form -->
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-hotel"></i> Booking Details</h2>
                    </div>
                    <div class="card-body">
                        <form id="bookingForm" th:action="@{/booking/submit}" method="post" data-validate="true">
                            <!-- CSRF Token -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            
                            <!-- Hidden fields for selected room data -->
                            <input type="hidden" id="roomId" name="roomId">
                            <input type="hidden" id="selectedRoomData" name="selectedRoomData">
                            
                            <!-- Room Selection Display -->
                            <div class="form-group">
                                <h3>Selected Room</h3>
                                <div id="selectedRoomDisplay" class="card">
                                    <div class="card-body">
                                        <div id="roomSelectionPlaceholder">
                                            <p class="text-center"><i class="fas fa-hotel"></i> Please select a room from the <a href="/rooms">rooms page</a> first</p>
                                        </div>
                                        <div id="selectedRoomInfo" style="display: none;">
                                            <h4 id="selectedRoomType">Room Type</h4>
                                            <p><strong>Room Number:</strong> <span id="selectedRoomNumber">-</span></p>
                                            <p><strong>Price per night:</strong> <span id="roomPricePerNight">-</span></p>
                                            <p><strong>Max Occupancy:</strong> <span id="selectedMaxOccupancy">-</span></p>
                                            <button type="button" class="btn btn-secondary" onclick="changeRoom()">🔄 Change Room</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Stay Details -->
                            <div class="form-group">
                                <h3>Stay Details</h3>
                                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label for="checkInDate">Check-in Date <span style="color: red;">*</span></label>
                                        <input type="date" 
                                               id="checkInDate" 
                                               name="checkInDate" 
                                               class="form-control" 
                                               required>
                                    </div>
                                    
                                    <div>
                                        <label for="checkOutDate">Check-out Date <span style="color: red;">*</span></label>
                                        <input type="date" 
                                               id="checkOutDate" 
                                               name="checkOutDate" 
                                               class="form-control" 
                                               required>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <label for="numberOfGuests">Number of Guests <span style="color: red;">*</span></label>
                                    <select id="numberOfGuests" name="numberOfGuests" class="form-control" required>
                                        <option value="">Select number of guests</option>
                                        <option value="1">1 Guest</option>
                                        <option value="2">2 Guests</option>
                                        <option value="3">3 Guests</option>
                                        <option value="4">4 Guests</option>
                                        <option value="5">5 Guests</option>
                                        <option value="6">6 Guests</option>
                                    </select>
                                </div>
                                
                                <div class="mt-2">
                                    <p><strong>Duration:</strong> <span id="stayDuration">Please select dates</span></p>
                                </div>
                            </div>
                            
                            <!-- Guest Information -->
                            <div class="form-group">
                                <h3>Primary Guest Information</h3>
                                <div class="alert alert-info">
                                    <small>This information will be used for the reservation. Make sure it matches your ID.</small>
                                </div>
                                
                                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label for="guestFirstName">First Name <span style="color: red;">*</span></label>
                                        <input type="text" 
                                               id="guestFirstName" 
                                               name="guestFirstName" 
                                               class="form-control" 
                                               th:value="${user != null ? user.firstName : ''}"
                                               required>
                                    </div>
                                    
                                    <div>
                                        <label for="guestLastName">Last Name <span style="color: red;">*</span></label>
                                        <input type="text" 
                                               id="guestLastName" 
                                               name="guestLastName" 
                                               class="form-control" 
                                               th:value="${user != null ? user.lastName : ''}"
                                               required>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <label for="guestEmail">Email Address <span style="color: red;">*</span></label>
                                    <input type="email" 
                                           id="guestEmail" 
                                           name="guestEmail" 
                                           class="form-control" 
                                           th:value="${user != null ? user.email : ''}"
                                           required>
                                </div>
                                
                                <div class="mt-2">
                                    <label for="guestPhone">Phone Number <span style="color: red;">*</span></label>
                                    <input type="tel" 
                                           id="guestPhone" 
                                           name="guestPhone" 
                                           class="form-control" 
                                           placeholder="+94771234567"
                                           required>
                                </div>
                                
                                <div class="mt-2">
                                    <label for="guestIdNumber">ID Number (Passport/NIC)</label>
                                    <input type="text" 
                                           id="guestIdNumber" 
                                           name="guestIdNumber" 
                                           class="form-control" 
                                           placeholder="Enter your ID/Passport number">
                                </div>
                            </div>
                            
                            <!-- Special Requests -->
                            <div class="form-group">
                                <h3>Special Requests & Preferences</h3>
                                <div>
                                    <label for="specialRequests">Special Requests (Optional)</label>
                                    <textarea id="specialRequests" 
                                              name="specialRequests" 
                                              class="form-control" 
                                              rows="4" 
                                              placeholder="Any special requests? (e.g., early check-in, late check-out, room preferences, dietary requirements, etc.)"></textarea>
                                    <small class="text-muted">We'll do our best to accommodate your requests subject to availability.</small>
                                </div>
                                
                                <div class="mt-2">
                                    <label for="customerNotes">Additional Notes (Optional)</label>
                                    <textarea id="customerNotes" 
                                              name="customerNotes" 
                                              class="form-control" 
                                              rows="3" 
                                              placeholder="Any additional information you'd like us to know about your stay..."></textarea>
                                </div>
                            </div>

                            <!-- Promo Code Section -->
                            <div class="form-group">
                                <h3><i class="fas fa-tag"></i> Promo Code</h3>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1rem; align-items: end;">
                                            <div>
                                                <label for="promoCode">Enter Promo Code (Optional)</label>
                                                <input type="text"
                                                       id="promoCode"
                                                       name="promoCode"
                                                       class="form-control"
                                                       placeholder="Enter your promo code (e.g., SUMMER25)"
                                                       style="text-transform: uppercase;">
                                                <small class="text-muted">Enter a valid promo code to get discount on your booking</small>
                                            </div>
                                            <div>
                                                <button type="button"
                                                        id="validatePromoBtn"
                                                        class="btn btn-outline-primary"
                                                        onclick="validatePromoCode()"
                                                        disabled>
                                                    🏷️ Apply
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Promo Code Status -->
                                        <div id="promoStatus" class="mt-2" style="display: none;">
                                            <div id="promoSuccess" class="alert alert-success" style="display: none;">
                                                <strong>🎉 Promo Code Applied!</strong>
                                                <p class="mb-1">Code: <strong id="appliedPromoCode"></strong></p>
                                                <p class="mb-1">Discount: <strong id="promoDiscount"></strong></p>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePromoCode()">
                                                    Remove Code
                                                </button>
                                            </div>
                                            <div id="promoError" class="alert alert-danger" style="display: none;">
                                                <strong><i class="fas fa-times-circle"></i> Invalid Promo Code</strong>
                                                <p class="mb-0" id="promoErrorMessage"></p>
                                            </div>
                                        </div>

                                        <!-- Current Promotions (Display some active promotions) -->
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <strong>Current Promotions:</strong>
                                                WELCOME10 (10% off for new customers),
                                                SUMMER25 (25% summer discount),
                                                WEEKEND15 (15% off weekend stays)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Arrival Information -->
                            <div class="form-group">
                                <h3>Arrival Information</h3>
                                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label for="estimatedArrivalTime">Estimated Arrival Time</label>
                                        <select id="estimatedArrivalTime" name="estimatedArrivalTime" class="form-control">
                                            <option value="">Select arrival time</option>
                                            <option value="06:00">6:00 AM - 8:00 AM</option>
                                            <option value="08:00">8:00 AM - 10:00 AM</option>
                                            <option value="10:00">10:00 AM - 12:00 PM</option>
                                            <option value="12:00">12:00 PM - 2:00 PM</option>
                                            <option value="14:00" selected>2:00 PM - 4:00 PM (Standard Check-in)</option>
                                            <option value="16:00">4:00 PM - 6:00 PM</option>
                                            <option value="18:00">6:00 PM - 8:00 PM</option>
                                            <option value="20:00">8:00 PM - 10:00 PM</option>
                                            <option value="22:00">After 10:00 PM (Late Check-in)</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label for="transportMode">How will you arrive?</label>
                                        <select id="transportMode" name="transportMode" class="form-control">
                                            <option value="">Select transport</option>
                                            <option value="car">Private Car</option>
                                            <option value="taxi">Taxi/Ride-share</option>
                                            <option value="airport_shuttle">Airport Shuttle</option>
                                            <option value="public_transport">Public Transport</option>
                                            <option value="walking">Walking</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Terms and Conditions -->
                            <div class="form-group">
                                <h3>Terms & Conditions</h3>
                                <div class="card">
                                    <div class="card-body">
                                        <div style="max-height: 150px; overflow-y: auto; font-size: 0.9rem; line-height: 1.4;">
                                            <h5>Booking Terms & Conditions</h5>
                                            <p><strong>Check-in/Check-out:</strong> Check-in: 2:00 PM | Check-out: 11:00 AM</p>
                                            <p><strong>Cancellation Policy:</strong> Free cancellation up to 24 hours before check-in. Late cancellations may incur charges.</p>
                                            <p><strong>Payment:</strong> Full payment is required at the time of booking via secure payment gateway.</p>
                                            <p><strong>Identification:</strong> Valid government-issued photo ID required at check-in.</p>
                                            <p><strong>Additional Guests:</strong> Extra charges may apply for additional guests beyond room capacity.</p>
                                            <p><strong>Smoking Policy:</strong> This is a non-smoking property. Smoking is only permitted in designated outdoor areas.</p>
                                            <p><strong>Pets:</strong> Pets are not allowed unless specifically stated otherwise.</p>
                                            <p><strong>Damages:</strong> Guests are responsible for any damages to hotel property during their stay.</p>
                                            <p><strong>Privacy:</strong> We respect your privacy and handle your personal information according to our privacy policy.</p>
                                        </div>
                                        
                                        <div class="mt-2">
                                            <label class="flex items-center gap-2">
                                                <input type="checkbox" id="agreeToTerms" name="agreeToTerms" required>
                                                <span>I have read and agree to the <a href="/terms" target="_blank">Terms & Conditions</a> and <a href="/privacy" target="_blank">Privacy Policy</a> <span style="color: red;">*</span></span>
                                            </label>
                                        </div>
                                        
                                        <div class="mt-1">
                                            <label class="flex items-center gap-2">
                                                <input type="checkbox" id="confirmDetails" name="confirmDetails" required>
                                                <span>I confirm that all the information provided is accurate and complete <span style="color: red;">*</span></span>
                                            </label>
                                        </div>
                                        
                                        <div class="mt-1">
                                            <label class="flex items-center gap-2">
                                                <input type="checkbox" id="emailNotifications" name="emailNotifications" checked>
                                                <span>I would like to receive booking confirmation and updates via email</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Submit Button -->
                            <div class="form-group">
                                <button type="submit" id="submitBookingBtn" class="btn btn-success form-control" disabled>
                                    💳 Proceed to Payment
                                </button>
                                <p class="text-center mt-2" style="font-size: 0.9rem; color: #666;">
                                    You'll be redirected to secure PayHere payment gateway
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Booking Summary Sidebar -->
                <div class="booking-summary">
                    <h3><i class="fas fa-clipboard-list"></i> Booking Summary</h3>
                    
                    <div id="summaryContent">
                        <div id="summaryPlaceholder" class="text-center">
                            <p>Please complete the booking form to see the summary</p>
                        </div>
                        
                        <div id="summaryDetails" style="display: none;">
                            <!-- Room Details -->
                            <div class="summary-section">
                                <h4>Room Details</h4>
                                <div class="summary-item">
                                    <span>Room Type:</span>
                                    <span id="summaryRoomType">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Room Number:</span>
                                    <span id="summaryRoomNumber">-</span>
                                </div>
                            </div>
                            
                            <!-- Stay Details -->
                            <div class="summary-section">
                                <h4>Stay Details</h4>
                                <div class="summary-item">
                                    <span>Check-in:</span>
                                    <span id="summaryCheckIn">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Check-out:</span>
                                    <span id="summaryCheckOut">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Duration:</span>
                                    <span id="summaryDuration">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Guests:</span>
                                    <span id="summaryGuests">-</span>
                                </div>
                            </div>
                            
                            <!-- Price Breakdown -->
                            <div class="summary-section">
                                <h4>Price Breakdown</h4>
                                <div class="summary-item">
                                    <span>Rate per night:</span>
                                    <span id="summaryRatePerNight">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Number of nights:</span>
                                    <span id="summaryNights">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Subtotal:</span>
                                    <span id="summarySubtotal">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Service charge (10%):</span>
                                    <span id="summaryServiceCharge">-</span>
                                </div>
                                <div class="summary-item">
                                    <span>Taxes (2%):</span>
                                    <span id="summaryTaxes">-</span>
                                </div>
                            </div>
                            
                            <!-- Total -->
                            <div class="total-amount">
                                <div class="summary-item">
                                    <span>Total Amount:</span>
                                    <span id="totalPrice">LKR 0.00</span>
                                </div>
                            </div>
                            
                            <!-- Payment Info -->
                            <div class="mt-2">
                                <div class="alert alert-info" style="padding: 0.75rem; font-size: 0.9rem;">
                                    <strong><i class="fas fa-credit-card"></i> Payment Info:</strong><br>
                                    Secure payment via PayHere<br>
                                    Supports Credit/Debit cards<br>
                                    Instant confirmation
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </section>
</div>
    
    <!-- Additional JavaScript for booking page -->
    <th:block th:fragment="additional-js">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                initializeBookingForm();
                loadSelectedRoomData();
                setupFormValidation();
                setupDateListeners();
                setupCheckboxListeners();
            });
            
            function initializeBookingForm() {
                // Set minimum dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('checkInDate').min = today;
                document.getElementById('checkOutDate').min = today;
            }
            
            function loadSelectedRoomData() {
                const selectedRoomData = JSON.parse(sessionStorage.getItem('selectedRoomData') || '{}');
                
                if (selectedRoomData.roomId) {
                    // Display selected room
                    document.getElementById('roomSelectionPlaceholder').style.display = 'none';
                    document.getElementById('selectedRoomInfo').style.display = 'block';
                    
                    document.getElementById('roomId').value = selectedRoomData.roomId;
                    document.getElementById('selectedRoomType').textContent = selectedRoomData.roomType;
                    document.getElementById('selectedRoomNumber').textContent = selectedRoomData.roomNumber;
                    document.getElementById('roomPricePerNight').textContent = `LKR ${selectedRoomData.pricePerNight.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                    document.getElementById('selectedMaxOccupancy').textContent = `${selectedRoomData.maxOccupancy} guests`;
                    
                    // Pre-fill form data
                    if (selectedRoomData.checkInDate) {
                        document.getElementById('checkInDate').value = selectedRoomData.checkInDate;
                    }
                    if (selectedRoomData.checkOutDate) {
                        document.getElementById('checkOutDate').value = selectedRoomData.checkOutDate;
                    }
                    if (selectedRoomData.numberOfGuests) {
                        document.getElementById('numberOfGuests').value = selectedRoomData.numberOfGuests;
                    }
                    
                    // Set up guest options based on max occupancy
                    setupGuestOptions(selectedRoomData.maxOccupancy);
                    
                    // Store room data in hidden field
                    document.getElementById('selectedRoomData').value = JSON.stringify(selectedRoomData);
                    
                    // Update summary
                    updateBookingSummary();
                } else {
                    // No room selected, show placeholder
                    document.getElementById('submitBookingBtn').disabled = true;
                    document.getElementById('submitBookingBtn').textContent = '🏨 Please Select a Room First';
                }
            }
            
            function setupGuestOptions(maxOccupancy) {
                const guestSelect = document.getElementById('numberOfGuests');
                guestSelect.innerHTML = '<option value="">Select number of guests</option>';
                
                for (let i = 1; i <= maxOccupancy; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} Guest${i !== 1 ? 's' : ''}`;
                    guestSelect.appendChild(option);
                }
            }
            
            function setupDateListeners() {
                const checkInDate = document.getElementById('checkInDate');
                const checkOutDate = document.getElementById('checkOutDate');
                
                checkInDate.addEventListener('change', function() {
                    checkOutDate.min = this.value;
                    if (checkOutDate.value && checkOutDate.value <= this.value) {
                        const nextDay = new Date(this.value);
                        nextDay.setDate(nextDay.getDate() + 1);
                        checkOutDate.value = nextDay.toISOString().split('T')[0];
                    }
                    updateBookingSummary();
                });
                
                checkOutDate.addEventListener('change', function() {
                    updateBookingSummary();
                });
                
                document.getElementById('numberOfGuests').addEventListener('change', function() {
                    updateBookingSummary();
                });
            }
            
            function setupCheckboxListeners() {
                const agreeToTerms = document.getElementById('agreeToTerms');
                const confirmDetails = document.getElementById('confirmDetails');
                const submitBtn = document.getElementById('submitBookingBtn');
                
                function updateSubmitButton() {
                    const roomSelected = document.getElementById('roomId').value;
                    const termsAccepted = agreeToTerms.checked;
                    const detailsConfirmed = confirmDetails.checked;
                    
                    console.log('updateSubmitButton called:', {
                        roomSelected: !!roomSelected,
                        termsAccepted,
                        detailsConfirmed
                    });
                    
                    if (roomSelected && termsAccepted && detailsConfirmed) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '💳 Proceed to Payment';
                        console.log('Submit button enabled');
                    } else {
                        submitBtn.disabled = true;
                        if (!roomSelected) {
                            submitBtn.textContent = '🏨 Please Select a Room First';
                        } else if (!termsAccepted || !detailsConfirmed) {
                            submitBtn.textContent = '<i class="fas fa-check-square"></i> Please Accept Terms & Confirm Details';
                        }
                        console.log('Submit button disabled');
                    }
                }
                
                agreeToTerms.addEventListener('change', updateSubmitButton);
                confirmDetails.addEventListener('change', updateSubmitButton);
                
                // Initial check
                updateSubmitButton();
            }
            
            function setupFormValidation() {
                const form = document.getElementById('bookingForm');
                
                form.addEventListener('submit', function(e) {
                    console.log('Form submit event triggered');
                    e.preventDefault();
                    
                    console.log('Form validation starting...');
                    if (validateBookingForm()) {
                        console.log('Form validation passed, calling submitBooking');
                        submitBooking();
                    } else {
                        console.log('Form validation failed');
                    }
                });
            }
            
            function validateBookingForm() {
                console.log('validateBookingForm called');
                let isValid = true;
                
                // Validate required fields
                const requiredFields = [
                    'checkInDate', 'checkOutDate', 'numberOfGuests',
                    'guestFirstName', 'guestLastName', 'guestEmail', 'guestPhone'
                ];
                
                console.log('Validating required fields...');
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (!field) {
                        console.error(`Field not found: ${fieldId}`);
                        isValid = false;
                        return;
                    }
                    
                    const value = field.value ? field.value.trim() : '';
                    console.log(`Field ${fieldId}: "${value}" (${value ? 'valid' : 'INVALID - empty'})`);
                    
                    if (!value) {
                        console.error(`Validation failed for field: ${fieldId}`);
                        showFieldError(field, 'This field is required');
                        isValid = false;
                    } else {
                        clearFieldError(field);
                    }
                });
                
                // Validate dates
                console.log('Validating dates...');
                const checkInField = document.getElementById('checkInDate');
                const checkOutField = document.getElementById('checkOutDate');
                
                if (!checkInField || !checkOutField) {
                    console.error('Date fields not found');
                    isValid = false;
                } else {
                    const checkIn = new Date(checkInField.value);
                    const checkOut = new Date(checkOutField.value);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    console.log(`Check-in date: ${checkInField.value} (${checkIn})`);
                    console.log(`Check-out date: ${checkOutField.value} (${checkOut})`);
                    console.log(`Today: ${today}`);
                    
                    if (checkIn < today) {
                        console.error('Check-in date validation failed: date is in the past');
                        showFieldError(checkInField, 'Check-in date cannot be in the past');
                        isValid = false;
                    }
                    
                    if (checkOut <= checkIn) {
                        console.error('Check-out date validation failed: not after check-in');
                        showFieldError(checkOutField, 'Check-out date must be after check-in date');
                        isValid = false;
                    }
                }
                
                // Validate email
                console.log('Validating email...');
                const emailField = document.getElementById('guestEmail');
                if (emailField) {
                    const email = emailField.value;
                    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    console.log(`Email: "${email}"`);
                    if (email && !emailPattern.test(email)) {
                        console.error('Email validation failed');
                        showFieldError(emailField, 'Please enter a valid email address');
                        isValid = false;
                    }
                }
                
                // Validate phone
                console.log('Validating phone...');
                const phoneField = document.getElementById('guestPhone');
                if (phoneField) {
                    const phone = phoneField.value;
                    const phonePattern = /^[+]?[0-9]{10,15}$/;
                    console.log(`Phone: "${phone}"`);
                    if (phone && !phonePattern.test(phone.replace(/\s/g, ''))) {
                        console.error('Phone validation failed');
                        showFieldError(phoneField, 'Please enter a valid phone number');
                        isValid = false;
                    }
                }
                
                console.log(`Form validation complete. Valid: ${isValid}`);
                return isValid;
            }
            
            function updateBookingSummary() {
                const checkInDate = document.getElementById('checkInDate').value;
                const checkOutDate = document.getElementById('checkOutDate').value;
                const numberOfGuests = document.getElementById('numberOfGuests').value;
                const selectedRoomData = JSON.parse(sessionStorage.getItem('selectedRoomData') || '{}');
                
                if (checkInDate && checkOutDate && numberOfGuests && selectedRoomData.roomId) {
                    const nights = calculateNights(checkInDate, checkOutDate);
                    const pricePerNight = selectedRoomData.pricePerNight;
                    const subtotal = nights * pricePerNight;
                    const serviceCharge = subtotal * 0.10; // 10% service charge
                    const taxes = subtotal * 0.02; // 2% taxes
                    const total = subtotal + serviceCharge + taxes;
                    
                    // Update summary display
                    document.getElementById('summaryPlaceholder').style.display = 'none';
                    document.getElementById('summaryDetails').style.display = 'block';
                    
                    document.getElementById('summaryRoomType').textContent = selectedRoomData.roomType;
                    document.getElementById('summaryRoomNumber').textContent = selectedRoomData.roomNumber;
                    document.getElementById('summaryCheckIn').textContent = formatDate(checkInDate);
                    document.getElementById('summaryCheckOut').textContent = formatDate(checkOutDate);
                    document.getElementById('summaryDuration').textContent = `${nights} night${nights !== 1 ? 's' : ''}`;
                    document.getElementById('summaryGuests').textContent = `${numberOfGuests} guest${numberOfGuests !== '1' ? 's' : ''}`;
                    document.getElementById('summaryRatePerNight').textContent = formatCurrency(pricePerNight);
                    document.getElementById('summaryNights').textContent = nights;
                    document.getElementById('summarySubtotal').textContent = formatCurrency(subtotal);
                    document.getElementById('summaryServiceCharge').textContent = formatCurrency(serviceCharge);
                    document.getElementById('summaryTaxes').textContent = formatCurrency(taxes);
                    document.getElementById('totalPrice').textContent = formatCurrency(total);
                    
                    // Update duration in main form
                    document.getElementById('stayDuration').textContent = `${nights} night${nights !== 1 ? 's' : ''}`;
                } else {
                    document.getElementById('summaryPlaceholder').style.display = 'block';
                    document.getElementById('summaryDetails').style.display = 'none';
                    document.getElementById('stayDuration').textContent = 'Please select dates';
                }
            }
            
            function calculateNights(checkIn, checkOut) {
                const start = new Date(checkIn);
                const end = new Date(checkOut);
                const diffTime = Math.abs(end - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            function formatCurrency(amount) {
                return `LKR ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            function submitBooking() {
                console.log('submitBooking called');
                
                // Create booking data with only the required fields for the API
                const bookingData = {
                    roomId: parseInt(document.getElementById('roomId').value),
                    checkInDate: document.getElementById('checkInDate').value,
                    checkOutDate: document.getElementById('checkOutDate').value,
                    numberOfGuests: parseInt(document.getElementById('numberOfGuests').value),
                    specialRequests: document.getElementById('specialRequests').value || '',
                    customerNotes: document.getElementById('customerNotes').value || ''
                };
                
                console.log('Booking data object:', bookingData);
                
                // Validate required fields
                if (!bookingData.roomId) {
                    showAlert('Please select a room', 'error');
                    return;
                }
                
                if (!bookingData.checkInDate || !bookingData.checkOutDate) {
                    showAlert('Please select check-in and check-out dates', 'error');
                    return;
                }
                
                if (!bookingData.numberOfGuests) {
                    showAlert('Please select number of guests', 'error');
                    return;
                }
                
                console.log('All validations passed, making API call');
                showLoading('Creating your booking...');
                
                const csrfToken = document.querySelector('input[name="_csrf"]').value;
                console.log('CSRF token:', csrfToken);
                
                fetch('/api/bookings/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(bookingData)
                })
                .then(response => {
                    console.log('API response status:', response.status);
                    console.log('API response headers:', response.headers);
                    return response.json();
                })
                .then(data => {
                    console.log('API response data:', data);
                    hideLoading();
                    
                    if (data.success && data.bookingId) {
                        console.log('Booking created successfully:', data.bookingReference);
                        // Store booking data for payment
                        sessionStorage.setItem('pendingBooking', JSON.stringify(data));
                        // Redirect to payment
                        console.log('Redirecting to payment page with bookingId:', data.bookingId);
                        window.location.href = '/payment?bookingId=' + data.bookingId;
                    } else {
                        console.error('Booking creation failed:', data.error);
                        showAlert(data.error || 'Error creating booking. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Error creating booking. Please check your connection and try again.', 'error');
                    console.error('Booking error:', error);
                });
            }
            
            function changeRoom() {
                if (confirm('Are you sure you want to change the room? You will lose the current booking details.')) {
                    sessionStorage.removeItem('selectedRoomData');
                    window.location.href = '/rooms';
                }
            }
            
            // Auto-save form data
            function autoSaveForm() {
                const formData = new FormData(document.getElementById('bookingForm'));
                const autoSaveData = {};
                
                for (let [key, value] of formData.entries()) {
                    if (value) {
                        autoSaveData[key] = value;
                    }
                }
                
                sessionStorage.setItem('bookingFormAutoSave', JSON.stringify(autoSaveData));
            }
            
            // Load auto-saved form data
            function loadAutoSavedData() {
                const autoSaveData = JSON.parse(sessionStorage.getItem('bookingFormAutoSave') || '{}');
                
                Object.keys(autoSaveData).forEach(key => {
                    const field = document.getElementById(key);
                    if (field && !field.value) {
                        field.value = autoSaveData[key];
                    }
                });
            }
            
            // Set up auto-save
            setTimeout(() => {
                loadAutoSavedData();
                
                // Save form data every 30 seconds
                setInterval(autoSaveForm, 30000);
                
                // Save when user leaves page
                window.addEventListener('beforeunload', autoSaveForm);
            }, 1000);

            // Promo Code Functions
            let appliedPromoData = null;

            function enablePromoValidation() {
                const promoCode = document.getElementById('promoCode').value.trim();
                const validateBtn = document.getElementById('validatePromoBtn');
                validateBtn.disabled = promoCode.length === 0;
            }

            // Enable/disable promo button based on input
            document.getElementById('promoCode').addEventListener('input', function() {
                this.value = this.value.toUpperCase(); // Convert to uppercase
                enablePromoValidation();

                // Hide previous results when typing
                document.getElementById('promoStatus').style.display = 'none';
                document.getElementById('promoSuccess').style.display = 'none';
                document.getElementById('promoError').style.display = 'none';
            });

            function validatePromoCode() {
                const promoCode = document.getElementById('promoCode').value.trim();
                if (!promoCode) {
                    showAlert('Please enter a promo code', 'error');
                    return;
                }

                // Check if we have booking data to validate against
                const selectedRoomData = JSON.parse(sessionStorage.getItem('selectedRoomData') || '{}');
                const checkInDate = document.getElementById('checkInDate').value;
                const checkOutDate = document.getElementById('checkOutDate').value;
                const numberOfGuests = document.getElementById('numberOfGuests').value;

                if (!selectedRoomData.roomId || !checkInDate || !checkOutDate || !numberOfGuests) {
                    showAlert('Please complete booking details first (room, dates, and guests)', 'error');
                    return;
                }

                // Calculate current total for validation
                const nights = calculateNights(checkInDate, checkOutDate);
                const pricePerNight = selectedRoomData.pricePerNight;
                const subtotal = nights * pricePerNight;
                const serviceCharge = subtotal * 0.10;
                const taxes = subtotal * 0.02;
                const currentTotal = subtotal + serviceCharge + taxes;

                const validateBtn = document.getElementById('validatePromoBtn');
                const originalText = validateBtn.textContent;
                validateBtn.disabled = true;
                validateBtn.textContent = 'Validating...';

                // Simulate validation (in real implementation, this would be an API call)
                // For demo purposes, we'll simulate some promo codes
                setTimeout(() => {
                    let isValid = false;
                    let discount = 0;
                    let discountType = 'percentage';
                    let errorMessage = '';

                    switch (promoCode) {
                        case 'WELCOME10':
                            if (currentTotal >= 5000) {
                                isValid = true;
                                discount = 10; // 10%
                                discountType = 'percentage';
                            } else {
                                errorMessage = 'Minimum booking amount of LKR 5,000 required for this promo code';
                            }
                            break;
                        case 'SUMMER25':
                            if (currentTotal >= 10000) {
                                isValid = true;
                                discount = 25; // 25%
                                discountType = 'percentage';
                            } else {
                                errorMessage = 'Minimum booking amount of LKR 10,000 required for this promo code';
                            }
                            break;
                        case 'FLAT2000':
                            if (currentTotal >= 15000) {
                                isValid = true;
                                discount = 2000; // Fixed amount
                                discountType = 'fixed';
                            } else {
                                errorMessage = 'Minimum booking amount of LKR 15,000 required for this promo code';
                            }
                            break;
                        case 'WEEKEND15':
                            isValid = true;
                            discount = 15; // 15%
                            discountType = 'percentage';
                            break;
                        default:
                            errorMessage = 'Invalid promo code. Please check and try again.';
                            break;
                    }

                    if (isValid) {
                        let discountAmount = 0;
                        if (discountType === 'percentage') {
                            discountAmount = currentTotal * (discount / 100);
                        } else {
                            discountAmount = discount;
                        }

                        // Apply maximum discount limit for percentage discounts
                        const maxDiscount = {
                            'WELCOME10': 5000,
                            'SUMMER25': 10000,
                            'WEEKEND15': 7500
                        };

                        if (discountType === 'percentage' && maxDiscount[promoCode]) {
                            discountAmount = Math.min(discountAmount, maxDiscount[promoCode]);
                        }

                        // Ensure discount doesn't exceed total
                        discountAmount = Math.min(discountAmount, currentTotal);

                        appliedPromoData = {
                            code: promoCode,
                            discountAmount: discountAmount,
                            originalTotal: currentTotal,
                            newTotal: currentTotal - discountAmount
                        };

                        showPromoSuccess(promoCode, discountAmount);
                        updateBookingSummaryWithPromo();
                    } else {
                        showPromoError(errorMessage);
                        appliedPromoData = null;
                    }

                    validateBtn.disabled = false;
                    validateBtn.textContent = originalText;
                }, 1000);
            }

            function showPromoSuccess(code, discountAmount) {
                document.getElementById('promoStatus').style.display = 'block';
                document.getElementById('promoSuccess').style.display = 'block';
                document.getElementById('promoError').style.display = 'none';

                document.getElementById('appliedPromoCode').textContent = code;
                document.getElementById('promoDiscount').textContent = formatCurrency(discountAmount);

                // Disable the input and change button text
                document.getElementById('promoCode').disabled = true;
                document.getElementById('validatePromoBtn').textContent = '<i class="fas fa-check"></i> Applied';
                document.getElementById('validatePromoBtn').disabled = true;
            }

            function showPromoError(message) {
                document.getElementById('promoStatus').style.display = 'block';
                document.getElementById('promoSuccess').style.display = 'none';
                document.getElementById('promoError').style.display = 'block';

                document.getElementById('promoErrorMessage').textContent = message;
            }

            function removePromoCode() {
                appliedPromoData = null;

                // Reset form
                document.getElementById('promoCode').value = '';
                document.getElementById('promoCode').disabled = false;
                document.getElementById('validatePromoBtn').textContent = '🏷️ Apply';
                document.getElementById('validatePromoBtn').disabled = true;

                // Hide status
                document.getElementById('promoStatus').style.display = 'none';
                document.getElementById('promoSuccess').style.display = 'none';
                document.getElementById('promoError').style.display = 'none';

                // Update summary
                updateBookingSummary();
            }

            function updateBookingSummaryWithPromo() {
                if (!appliedPromoData) {
                    updateBookingSummary();
                    return;
                }

                // First run normal update
                updateBookingSummary();

                // Then add promo discount
                const priceBreakdown = document.querySelector('.summary-section');

                // Remove existing promo elements
                const existingPromoDiscount = document.getElementById('promoDiscountRow');
                const existingNewTotal = document.getElementById('newTotalRow');
                if (existingPromoDiscount) existingPromoDiscount.remove();
                if (existingNewTotal) existingNewTotal.remove();

                // Add promo discount row
                const promoRow = document.createElement('div');
                promoRow.className = 'summary-item';
                promoRow.id = 'promoDiscountRow';
                promoRow.style.color = '#28a745';
                promoRow.innerHTML = `
                    <span>Promo discount (${appliedPromoData.code}):</span>
                    <span>-${formatCurrency(appliedPromoData.discountAmount)}</span>
                `;
                priceBreakdown.appendChild(promoRow);

                // Update total amount
                document.getElementById('totalPrice').textContent = formatCurrency(appliedPromoData.newTotal);
                document.getElementById('totalPrice').style.color = '#28a745';
            }

            // Modify the original submitBooking function to include promo code
            const originalSubmitBooking = submitBooking;
            submitBooking = function() {
                console.log('submitBooking called with promo data:', appliedPromoData);

                // Create booking data with promo code if applied
                const bookingData = {
                    roomId: parseInt(document.getElementById('roomId').value),
                    checkInDate: document.getElementById('checkInDate').value,
                    checkOutDate: document.getElementById('checkOutDate').value,
                    numberOfGuests: parseInt(document.getElementById('numberOfGuests').value),
                    specialRequests: document.getElementById('specialRequests').value || '',
                    customerNotes: document.getElementById('customerNotes').value || ''
                };

                console.log('Booking data object:', bookingData);

                // Validate required fields (same as original)
                if (!bookingData.roomId) {
                    showAlert('Please select a room', 'error');
                    return;
                }

                if (!bookingData.checkInDate || !bookingData.checkOutDate) {
                    showAlert('Please select check-in and check-out dates', 'error');
                    return;
                }

                if (!bookingData.numberOfGuests) {
                    showAlert('Please select number of guests', 'error');
                    return;
                }

                console.log('All validations passed, making API call');
                showLoading('Creating your booking...');

                const csrfToken = document.querySelector('input[name="_csrf"]').value;
                console.log('CSRF token:', csrfToken);

                // Choose endpoint based on whether promo code is applied
                let endpoint = '/api/bookings/create';
                let promoParam = '';

                if (appliedPromoData && appliedPromoData.code) {
                    endpoint = '/api/bookings/create-with-promo';
                    promoParam = `?promoCode=${encodeURIComponent(appliedPromoData.code)}`;
                    console.log('Using promo code endpoint with code:', appliedPromoData.code);
                }

                fetch(endpoint + promoParam, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(bookingData)
                })
                .then(response => {
                    console.log('API response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API response data:', data);
                    hideLoading();

                    if (data.success && data.booking) {
                        console.log('Booking created successfully:', data.booking.bookingReference);

                        // Store booking data for payment
                        sessionStorage.setItem('pendingBooking', JSON.stringify(data));

                        // Redirect to payment
                        console.log('Redirecting to payment page with bookingId:', data.booking.bookingId);
                        window.location.href = '/payment?bookingId=' + data.booking.bookingId;
                    } else {
                        console.error('Booking creation failed:', data.error);
                        showAlert(data.error || 'Error creating booking. Please try again.', 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Error creating booking. Please check your connection and try again.', 'error');
                    console.error('Booking error:', error);
                });
            };
        </script>
    </th:block>
    
    <!-- Additional CSS for booking page -->
    <th:block th:fragment="additional-css">
        <style>
            .sticky-top {
                top: 2rem;
            }
        </style>
    </th:block>
</body>
</html>